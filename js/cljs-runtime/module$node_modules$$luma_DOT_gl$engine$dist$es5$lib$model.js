shadow$provide.module$node_modules$$luma_DOT_gl$engine$dist$es5$lib$model=function(global,require,module,exports){global=require("module$node_modules$$babel$runtime$helpers$interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0});exports["default"]=void 0;var _defineProperty2=global(require("module$node_modules$$babel$runtime$helpers$defineProperty")),_classCallCheck2=global(require("module$node_modules$$babel$runtime$helpers$classCallCheck")),_createClass2=global(require("module$node_modules$$babel$runtime$helpers$createClass")),
_gltools=require("module$node_modules$$luma_DOT_gl$gltools$dist$es5$index"),_programManager=global(require("module$node_modules$$luma_DOT_gl$engine$dist$es5$lib$program_manager")),_webgl=require("module$node_modules$$luma_DOT_gl$webgl$dist$es5$index"),_modelUtils=require("module$node_modules$$luma_DOT_gl$engine$dist$es5$lib$model_utils"),NOOP=function(){},DRAW_PARAMS={};require=function(){function Model(gl){var props=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};(0,_classCallCheck2["default"])(this,
Model);var _props$id=props.id;_props$id=void 0===_props$id?(0,_webgl.uid)("model"):_props$id;(0,_webgl.assert)((0,_gltools.isWebGL)(gl));this.id=_props$id;this.gl=gl;this.id=props.id||(0,_webgl.uid)("Model");this.lastLogTime=0;this.animated=!1;this.initialize(props)}(0,_createClass2["default"])(Model,[{key:"initialize",value:function(props){this.props={};this.programManager=props.programManager||_programManager["default"].getDefaultProgramManager(this.gl);this._programManagerState=-1;this._managedProgram=
!1;var _props$program=props.program;this.programProps={program:void 0===_props$program?null:_props$program,vs:props.vs,fs:props.fs,modules:props.modules,defines:props.defines,inject:props.inject,varyings:props.varyings,bufferMode:props.bufferMode,transpileToGLSL100:props.transpileToGLSL100};this.vertexArray=this.program=null;this._programDirty=!0;this.userData={};this.needsRedraw=!0;this._attributes={};this.attributes={};this.uniforms={};this.pickable=!0;this._checkProgram();this.setUniforms(Object.assign({},
this.getModuleUniforms(props.moduleSettings)));this.drawMode=void 0!==props.drawMode?props.drawMode:4;this.vertexCount=props.vertexCount||0;this.geometryBuffers={};this.isInstanced=props.isInstanced||props.instanced||0<props.instanceCount;this._setModelProps(props);this.geometry={};(0,_webgl.assert)(void 0!==this.drawMode&&Number.isFinite(this.vertexCount),"Model needs drawMode and vertexCount")}},{key:"setProps",value:function(props){this._setModelProps(props)}},{key:"delete",value:function(){for(var key in this._attributes)if(this._attributes[key]!==
this.attributes[key])this._attributes[key]["delete"]();this._managedProgram&&(this.programManager.release(this.program),this._managedProgram=!1);this.vertexArray["delete"]();this._deleteGeometryBuffers()}},{key:"getDrawMode",value:function(){return this.drawMode}},{key:"getVertexCount",value:function(){return this.vertexCount}},{key:"getInstanceCount",value:function(){return this.instanceCount}},{key:"getAttributes",value:function(){return this.attributes}},{key:"getProgram",value:function(){return this.program}},
{key:"setProgram",value:function(props){this.programProps={program:props.program,vs:props.vs,fs:props.fs,modules:props.modules,defines:props.defines,inject:props.inject,varyings:props.varyings,bufferMode:props.bufferMode,transpileToGLSL100:props.transpileToGLSL100};this._programDirty=!0}},{key:"getUniforms",value:function(){return this.uniforms}},{key:"setDrawMode",value:function(drawMode){this.drawMode=drawMode;return this}},{key:"setVertexCount",value:function(vertexCount){(0,_webgl.assert)(Number.isFinite(vertexCount));
this.vertexCount=vertexCount;return this}},{key:"setInstanceCount",value:function(instanceCount){(0,_webgl.assert)(Number.isFinite(instanceCount));this.instanceCount=instanceCount;return this}},{key:"setGeometry",value:function(geometry){this.drawMode=geometry.drawMode;this.vertexCount=geometry.getVertexCount();this._deleteGeometryBuffers();this.geometryBuffers=(0,_modelUtils.getBuffersFromGeometry)(this.gl,geometry);this.vertexArray.setAttributes(this.geometryBuffers);return this}},{key:"setAttributes",
value:function(){var attributes=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if((0,_webgl.isObjectEmpty)(attributes))return this;var normalizedAttributes={},name;for(name in attributes){var attribute=attributes[name];normalizedAttributes[name]=attribute.getValue?attribute.getValue():attribute}this.vertexArray.setAttributes(normalizedAttributes);return this}},{key:"setUniforms",value:function(){Object.assign(this.uniforms,0<arguments.length&&void 0!==arguments[0]?arguments[0]:{});return this}},
{key:"getModuleUniforms",value:function(opts){this._checkProgram();var getUniforms=this.programManager.getUniforms(this.program);return getUniforms?getUniforms(opts):{}}},{key:"updateModuleSettings",value:function(opts){opts=this.getModuleUniforms(opts||{});return this.setUniforms(opts)}},{key:"clear",value:function(opts){(0,_webgl.clear)(this.program.gl,opts);return this}},{key:"draw",value:function(){var opts=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this._checkProgram();var _opts$moduleSettings=
opts.moduleSettings,moduleSettings=void 0===_opts$moduleSettings?null:_opts$moduleSettings;_opts$moduleSettings=opts.framebuffer;var _opts$uniforms=opts.uniforms,uniforms=void 0===_opts$uniforms?{}:_opts$uniforms,_opts$attributes=opts.attributes;_opts$uniforms=opts.transformFeedback;_opts$uniforms=void 0===_opts$uniforms?this.transformFeedback:_opts$uniforms;var _opts$parameters=opts.parameters;_opts$parameters=void 0===_opts$parameters?{}:_opts$parameters;var _opts$vertexArray=opts.vertexArray;_opts$vertexArray=
void 0===_opts$vertexArray?this.vertexArray:_opts$vertexArray;this.setAttributes(void 0===_opts$attributes?{}:_opts$attributes);this.updateModuleSettings(moduleSettings);this.setUniforms(uniforms);var logPriority;2<=_webgl.log.priority&&(logPriority=this._logDrawCallStart(2));var drawParams=this.vertexArray.getDrawParams(),_this$props=this.props;moduleSettings=_this$props.isIndexed;moduleSettings=void 0===moduleSettings?drawParams.isIndexed:moduleSettings;uniforms=_this$props.indexType;uniforms=void 0===
uniforms?drawParams.indexType:uniforms;_opts$attributes=_this$props.indexOffset;_opts$attributes=void 0===_opts$attributes?drawParams.indexOffset:_opts$attributes;_this$props=_this$props.vertexArrayInstanced;(void 0===_this$props?drawParams.isInstanced:_this$props)&&!this.isInstanced&&_webgl.log.warn("Found instanced attributes on non-instanced model",this.id)();drawParams=this.isInstanced;_this$props=this.instanceCount;var _this$props2=this.props,_this$props2$onBefore=_this$props2.onBeforeRender;
_this$props2=_this$props2.onAfterRender;_this$props2=void 0===_this$props2?NOOP:_this$props2;(void 0===_this$props2$onBefore?NOOP:_this$props2$onBefore)();this.program.setUniforms(this.uniforms);opts=this.program.draw(Object.assign(DRAW_PARAMS,opts,{logPriority,uniforms:null,framebuffer:_opts$moduleSettings,parameters:_opts$parameters,drawMode:this.getDrawMode(),vertexCount:this.getVertexCount(),vertexArray:_opts$vertexArray,transformFeedback:_opts$uniforms,isIndexed:moduleSettings,indexType:uniforms,
isInstanced:drawParams,instanceCount:_this$props,offset:moduleSettings?_opts$attributes:0}));_this$props2();2<=_webgl.log.priority&&this._logDrawCallEnd(logPriority,_opts$vertexArray,_opts$moduleSettings);return opts}},{key:"transform",value:function(){var opts=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},_opts$discard=opts.discard;_opts$discard=void 0===_opts$discard?!0:_opts$discard;var feedbackBuffers=opts.feedbackBuffers,_opts$unbindModels=opts.unbindModels;_opts$unbindModels=void 0===
_opts$unbindModels?[]:_opts$unbindModels;var parameters=opts.parameters;feedbackBuffers&&this._setFeedbackBuffers(feedbackBuffers);_opts$discard&&(parameters=Object.assign({},parameters,(0,_defineProperty2["default"])({},35977,_opts$discard)));_opts$unbindModels.forEach(function(model){return model.vertexArray.unbindBuffers()});try{this.draw(Object.assign({},opts,{parameters}))}finally{_opts$unbindModels.forEach(function(model){return model.vertexArray.bindBuffers()})}return this}},{key:"render",
value:function(){var uniforms=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_webgl.log.warn("Model.render() is deprecated. Use Model.setUniforms() and Model.draw()")();return this.setUniforms(uniforms).draw()}},{key:"_setModelProps",value:function(props){Object.assign(this.props,props);"uniforms"in props&&this.setUniforms(props.uniforms);"pickable"in props&&(this.pickable=props.pickable);"instanceCount"in props&&(this.instanceCount=props.instanceCount);"geometry"in props&&this.setGeometry(props.geometry);
"attributes"in props&&this.setAttributes(props.attributes);"_feedbackBuffers"in props&&this._setFeedbackBuffers(props._feedbackBuffers)}},{key:"_checkProgram",value:function(){if(this._programDirty||this.programManager.stateHash!==this._programManagerState){var program=this.programProps.program;program?this._managedProgram=!1:(program=this.programProps,program=this.programManager.get({vs:program.vs,fs:program.fs,modules:program.modules,inject:program.inject,defines:program.defines,varyings:program.varyings,
bufferMode:program.bufferMode,transpileToGLSL100:program.transpileToGLSL100}),this.program&&this._managedProgram&&this.programManager.release(this.program),this._programManagerState=this.programManager.stateHash,this._managedProgram=!0);(0,_webgl.assert)(program instanceof _webgl.Program,"Model needs a program");this._programDirty=!1;program!==this.program&&(this.program=program,this.vertexArray?this.vertexArray.setProps({program:this.program,attributes:this.vertexArray.attributes}):this.vertexArray=
new _webgl.VertexArray(this.gl,{program:this.program}),this.setUniforms(Object.assign({},this.getModuleUniforms())))}}},{key:"_deleteGeometryBuffers",value:function(){for(var name in this.geometryBuffers){var buffer=this.geometryBuffers[name][0]||this.geometryBuffers[name];if(buffer instanceof _webgl.Buffer)buffer["delete"]()}}},{key:"_setAnimationProps",value:function(animationProps){this.animated&&(0,_webgl.assert)(animationProps,"Model.draw(): animated uniforms but no animationProps")}},{key:"_setFeedbackBuffers",
value:function(){var feedbackBuffers=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if((0,_webgl.isObjectEmpty)(feedbackBuffers))return this;var gl=this.program.gl;this.transformFeedback=this.transformFeedback||new _webgl.TransformFeedback(gl,{program:this.program});this.transformFeedback.setBuffers(feedbackBuffers);return this}},{key:"_logDrawCallStart",value:function(logLevel){var logDrawTimeout=3<logLevel?0:1E4;if(!(Date.now()-this.lastLogTime<logDrawTimeout))return this.lastLogTime=
Date.now(),_webgl.log.group(2,"\x3e\x3e\x3e DRAWING MODEL ".concat(this.id),{collapsed:2>=_webgl.log.level})(),logLevel}},{key:"_logDrawCallEnd",value:function(logLevel,vertexArray,uniforms,framebuffer){if(void 0!==logLevel){vertexArray=(0,_webgl.getDebugTableForVertexArray)({vertexArray,header:"".concat(this.id," attributes"),attributes:this._attributes});var _getDebugTableForUnif=(0,_webgl.getDebugTableForUniforms)({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},
this.program.uniforms,uniforms)}),uniformTable=_getDebugTableForUnif.table,unusedTable=_getDebugTableForUnif.unusedTable;_getDebugTableForUnif=_getDebugTableForUnif.unusedCount;uniforms=(0,_webgl.getDebugTableForUniforms)({header:"".concat(this.id," uniforms"),program:this.program,uniforms:Object.assign({},this.program.uniforms,uniforms),undefinedOnly:!0});var missingTable=uniforms.table;0<uniforms.count&&_webgl.log.log("MISSING UNIFORMS",Object.keys(missingTable))();0<_getDebugTableForUnif&&_webgl.log.log("UNUSED UNIFORMS",
Object.keys(unusedTable))();unusedTable=(0,_webgl.getDebugTableForProgramConfiguration)(this.vertexArray.configuration);_webgl.log.table(logLevel,vertexArray)();_webgl.log.table(logLevel,uniformTable)();_webgl.log.table(logLevel+1,unusedTable)();framebuffer&&framebuffer.log({logLevel:2,message:"Rendered to ".concat(framebuffer.id)});_webgl.log.groupEnd(2,"\x3e\x3e\x3e DRAWING MODEL ".concat(this.id))()}}}]);return Model}();exports["default"]=require}
//# sourceMappingURL=module$node_modules$$luma_DOT_gl$engine$dist$es5$lib$model.js.map
