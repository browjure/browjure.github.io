shadow$provide.module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$utils$cpu_aggregator=function(global,require,module,exports){function nop(){}global=require("module$node_modules$$babel$runtime$helpers$interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0});exports["default"]=void 0;var _typeof2=global(require("module$node_modules$$babel$runtime$helpers$typeof")),_defineProperty2=global(require("module$node_modules$$babel$runtime$helpers$defineProperty")),_classCallCheck2=
global(require("module$node_modules$$babel$runtime$helpers$classCallCheck")),_createClass2=global(require("module$node_modules$$babel$runtime$helpers$createClass")),_binSorter=global(require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$utils$bin_sorter")),_scaleUtils=require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$utils$scale_utils"),_aggregationOperationUtils=require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$utils$aggregation_operation_utils"),
dimensionSteps=["getBins","getDomain","getScaleFunc"],_defaultDimensions=[{key:"fillColor",accessor:"getFillColor",pickingInfo:"colorValue",getBins:{triggers:{value:{prop:"getColorValue",updateTrigger:"getColorValue"},weight:{prop:"getColorWeight",updateTrigger:"getColorWeight"},aggregation:{prop:"colorAggregation"},filterData:{prop:"_filterData",updateTrigger:"_filterData"}}},getDomain:{triggers:{lowerPercentile:{prop:"lowerPercentile"},upperPercentile:{prop:"upperPercentile"},scaleType:{prop:"colorScaleType"}}},
getScaleFunc:{triggers:{domain:{prop:"colorDomain"},range:{prop:"colorRange"}},onSet:{props:"onSetColorDomain"}},nullValue:[0,0,0,0]},{key:"elevation",accessor:"getElevation",pickingInfo:"elevationValue",getBins:{triggers:{value:{prop:"getElevationValue",updateTrigger:"getElevationValue"},weight:{prop:"getElevationWeight",updateTrigger:"getElevationWeight"},aggregation:{prop:"elevationAggregation"},filterData:{prop:"_filterData",updateTrigger:"_filterData"}}},getDomain:{triggers:{lowerPercentile:{prop:"elevationLowerPercentile"},
upperPercentile:{prop:"elevationUpperPercentile"},scaleType:{prop:"elevationScaleType"}}},getScaleFunc:{triggers:{domain:{prop:"elevationDomain"},range:{prop:"elevationRange"}},onSet:{props:"onSetElevationDomain"}},nullValue:-1}],defaultGetCellSize=function(props){return props.cellSize};require=function(){function CPUAggregator(opts){(0,_classCallCheck2["default"])(this,CPUAggregator);this.state={layerData:{},dimensions:{}};this.changeFlags={};this.dimensionUpdaters={};this._getCellSize=opts.getCellSize||
defaultGetCellSize;this._getAggregator=opts.getAggregator;this._addDimension(opts.dimensions||_defaultDimensions)}(0,_createClass2["default"])(CPUAggregator,[{key:"updateState",value:function(opts,aggregationParams){var oldProps=opts.oldProps,props=opts.props;opts=opts.changeFlags;this.updateGetValueFuncs(oldProps,props,opts);var reprojectNeeded=this.needsReProjectPoints(oldProps,props,opts);opts.dataChanged||reprojectNeeded?this.getAggregatedData(props,aggregationParams):(this.getDimensionChanges(oldProps,
props,opts)||[]).forEach(function(f){return"function"===typeof f&&f()});this.setState({aggregationDirty:!0});return this.state}},{key:"setState",value:function(updateObject){this.state=Object.assign({},this.state,updateObject)}},{key:"setDimensionState",value:function(key,updateObject){this.setState({dimensions:Object.assign({},this.state.dimensions,(0,_defineProperty2["default"])({},key,Object.assign({},this.state.dimensions[key],updateObject)))})}},{key:"normalizeResult",value:function(){var result=
0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return result.hexagons?Object.assign({data:result.hexagons},result):result.layerData?Object.assign({data:result.layerData},result):result}},{key:"getAggregatedData",value:function(props,aggregationParams){aggregationParams=this._getAggregator(props)(props,aggregationParams);this.setState({layerData:this.normalizeResult(aggregationParams)});this.changeFlags={layerData:!0};this.getSortedBins(props)}},{key:"updateGetValueFuncs",value:function(oldProps,
props,changeFlags){for(var key in this.dimensionUpdaters){var _this$dimensionUpdate=this.dimensionUpdaters[key].getBins.triggers,weight=_this$dimensionUpdate.weight,aggregation=_this$dimensionUpdate.aggregation;_this$dimensionUpdate=props[_this$dimensionUpdate.value.prop];this.needUpdateDimensionStep(this.dimensionUpdaters[key].getBins,oldProps,props,changeFlags)&&(_this$dimensionUpdate=_this$dimensionUpdate?(0,_aggregationOperationUtils.wrapGetValueFunc)(_this$dimensionUpdate,{data:props.data}):
(0,_aggregationOperationUtils.getValueFunc)(props[aggregation.prop],props[weight.prop],{data:props.data}));_this$dimensionUpdate&&this.setDimensionState(key,{getValue:_this$dimensionUpdate})}}},{key:"needsReProjectPoints",value:function(oldProps,props,changeFlags){return this._getCellSize(oldProps)!==this._getCellSize(props)||this._getAggregator(oldProps)!==this._getAggregator(props)||changeFlags.updateTriggersChanged&&(changeFlags.updateTriggersChanged.all||changeFlags.updateTriggersChanged.getPosition)}},
{key:"addDimension",value:function(dimensions){this._addDimension(dimensions)}},{key:"_addDimension",value:function(){var _this=this;(0<arguments.length&&void 0!==arguments[0]?arguments[0]:[]).forEach(function(dimension){var key=dimension.key;_this.dimensionUpdaters[key]=_this.getDimensionUpdaters(dimension);_this.state.dimensions[key]={getValue:null,domain:null,sortedBins:null,scaleFunc:nop}})}},{key:"getDimensionUpdaters",value:function(_ref){var key=_ref.key,getDomain=_ref.getDomain,getScaleFunc=
_ref.getScaleFunc,nullValue=_ref.nullValue;return{key,accessor:_ref.accessor,pickingInfo:_ref.pickingInfo,getBins:Object.assign({updater:this.getDimensionSortedBins},_ref.getBins),getDomain:Object.assign({updater:this.getDimensionValueDomain},getDomain),getScaleFunc:Object.assign({updater:this.getDimensionScale},getScaleFunc),attributeAccessor:this.getSubLayerDimensionAttribute(key,nullValue)}}},{key:"needUpdateDimensionStep",value:function(dimensionStep,oldProps,props,changeFlags){return Object.values(dimensionStep.triggers).some(function(item){return item.updateTrigger?
changeFlags.dataChanged||changeFlags.updateTriggersChanged&&(changeFlags.updateTriggersChanged.all||changeFlags.updateTriggersChanged[item.updateTrigger]):oldProps[item.prop]!==props[item.prop]})}},{key:"getDimensionChanges",value:function(oldProps,props,changeFlags){var _this2=this,updaters=[],_loop=function(key){var needUpdate=dimensionSteps.find(function(step){return _this2.needUpdateDimensionStep(_this2.dimensionUpdaters[key][step],oldProps,props,changeFlags)});needUpdate&&updaters.push(_this2.dimensionUpdaters[key][needUpdate].updater.bind(_this2,
props,_this2.dimensionUpdaters[key]))},key$jscomp$0;for(key$jscomp$0 in this.dimensionUpdaters)_loop(key$jscomp$0);return updaters.length?updaters:null}},{key:"getUpdateTriggers",value:function(props){var _this3=this,_updateTriggers=props.updateTriggers||{},updateTriggers={},_loop2=function(key){var accessor=_this3.dimensionUpdaters[key].accessor;updateTriggers[accessor]={};dimensionSteps.forEach(function(step){Object.values(_this3.dimensionUpdaters[key][step].triggers).forEach(function(_ref2){var prop=
_ref2.prop;(_ref2=_ref2.updateTrigger)?(_ref2=_updateTriggers[_ref2],"object"!==(0,_typeof2["default"])(_ref2)||Array.isArray(_ref2)?void 0!==_ref2&&(updateTriggers[accessor][prop]=_ref2):Object.assign(updateTriggers[accessor],_ref2)):updateTriggers[accessor][prop]=props[prop]})})},key$jscomp$0;for(key$jscomp$0 in this.dimensionUpdaters)_loop2(key$jscomp$0);return updateTriggers}},{key:"getSortedBins",value:function(props){for(var key in this.dimensionUpdaters)this.getDimensionSortedBins(props,this.dimensionUpdaters[key])}},
{key:"getDimensionSortedBins",value:function(props,dimensionUpdater){var key=dimensionUpdater.key,sortedBins=new _binSorter["default"](this.state.layerData.data||[],{getValue:this.state.dimensions[key].getValue,filterData:props._filterData});this.setDimensionState(key,{sortedBins});this.getDimensionValueDomain(props,dimensionUpdater)}},{key:"getDimensionValueDomain",value:function(props,dimensionUpdater){var key=dimensionUpdater.key,_getDomain$triggers=dimensionUpdater.getDomain.triggers;_getDomain$triggers=
this.state.dimensions[key].sortedBins.getValueDomainByScale(props[_getDomain$triggers.scaleType.prop],[props[_getDomain$triggers.lowerPercentile.prop],props[_getDomain$triggers.upperPercentile.prop]]);this.setDimensionState(key,{valueDomain:_getDomain$triggers});this.getDimensionScale(props,dimensionUpdater)}},{key:"getDimensionScale",value:function(props,dimensionUpdater){var key=dimensionUpdater.key,getScaleFunc=dimensionUpdater.getScaleFunc,_getScaleFunc$trigger=getScaleFunc.triggers;dimensionUpdater=
dimensionUpdater.getDomain.triggers.scaleType;getScaleFunc=getScaleFunc.onSet;var dimensionRange=props[_getScaleFunc$trigger.range.prop];_getScaleFunc$trigger=props[_getScaleFunc$trigger.domain.prop]||this.state.dimensions[key].valueDomain;_getScaleFunc$trigger=(0,_scaleUtils.getScaleFunctionByScaleType)(dimensionUpdater&&props[dimensionUpdater.prop])(_getScaleFunc$trigger,dimensionRange);if("object"===(0,_typeof2["default"])(getScaleFunc)&&"function"===typeof props[getScaleFunc.props])props[getScaleFunc.props](_getScaleFunc$trigger.domain());
this.setDimensionState(key,{scaleFunc:_getScaleFunc$trigger})}},{key:"getSubLayerDimensionAttribute",value:function(key,nullValue){var _this4=this;return function(cell){var _this4$state$dimensio=_this4.state.dimensions[key],scaleFunc=_this4$state$dimensio.scaleFunc;if((cell=_this4$state$dimensio.sortedBins.binMap[cell.index])&&0===cell.counts)return nullValue;cell=cell&&cell.value;_this4$state$dimensio=scaleFunc.domain();return cell>=_this4$state$dimensio[0]&&cell<=_this4$state$dimensio[_this4$state$dimensio.length-
1]?scaleFunc(cell):nullValue}}},{key:"getSubLayerAccessors",value:function(props){var accessors={},key;for(key in this.dimensionUpdaters)accessors[this.dimensionUpdaters[key].accessor]=this.getSubLayerDimensionAttribute(props,key);return accessors}},{key:"getPickingInfo",value:function(_ref3){_ref3=_ref3.info;var object=null;if(_ref3.picked&&-1<_ref3.index){object=this.state.layerData.data[_ref3.index];var binInfo={},key;for(key in this.dimensionUpdaters){var sortedBins=this.state.dimensions[key].sortedBins;
binInfo[this.dimensionUpdaters[key].pickingInfo]=sortedBins.binMap[object.index]&&sortedBins.binMap[object.index].value}object=Object.assign(binInfo,object,{points:object.filteredPoints||object.points})}return Object.assign(_ref3,{picked:!!object,object})}},{key:"getAccessor",value:function(dimensionKey){return this.dimensionUpdaters.hasOwnProperty(dimensionKey)?this.dimensionUpdaters[dimensionKey].attributeAccessor:nop}}],[{key:"defaultDimensions",value:function(){return _defaultDimensions}}]);return CPUAggregator}();
exports["default"]=require}
//# sourceMappingURL=module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$utils$cpu_aggregator.js.map
