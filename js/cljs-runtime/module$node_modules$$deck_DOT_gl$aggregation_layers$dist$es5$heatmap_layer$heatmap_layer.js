shadow$provide.module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$heatmap_layer$heatmap_layer=function(global,require,module,exports){function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}));keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<
arguments.length;i++){var source=null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach(function(key){(0,_defineProperty2["default"])(target,key,source[key])}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})}return target}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();
return function(){var Super=(0,_getPrototypeOf2["default"])(Derived);if(hasNativeReflectConstruct){var NewTarget=(0,_getPrototypeOf2["default"])(this).constructor;Super=Reflect.construct(Super,arguments,NewTarget)}else Super=Super.apply(this,arguments);return(0,_possibleConstructorReturn2["default"])(this,Super)}}function _isNativeReflectConstruct(){if("undefined"===typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,
[],function(){})),!0}catch(e){return!1}}module=require("module$node_modules$$babel$runtime$helpers$interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0});exports["default"]=void 0;var _slicedToArray2=module(require("module$node_modules$$babel$runtime$helpers$slicedToArray")),_classCallCheck2=module(require("module$node_modules$$babel$runtime$helpers$classCallCheck")),_createClass2=module(require("module$node_modules$$babel$runtime$helpers$createClass")),_get2=module(require("module$node_modules$$babel$runtime$helpers$get")),
_inherits2=module(require("module$node_modules$$babel$runtime$helpers$inherits")),_possibleConstructorReturn2=module(require("module$node_modules$$babel$runtime$helpers$possibleConstructorReturn")),_getPrototypeOf2=module(require("module$node_modules$$babel$runtime$helpers$getPrototypeOf")),_defineProperty2=module(require("module$node_modules$$babel$runtime$helpers$defineProperty")),_heatmapLayerUtils=require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$heatmap_layer$heatmap_layer_utils"),
_core=require("module$node_modules$$luma_DOT_gl$core$dist$es5$index"),_core2=require("module$node_modules$$deck_DOT_gl$core$dist$es5$index"),_triangleLayer=module(require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$heatmap_layer$triangle_layer"));global=module(require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$aggregation_layer"));var _colorUtils=require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$utils$color_utils"),_weightsVs=module(require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$heatmap_layer$weights_vs_glsl")),
_weightsFs=module(require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$heatmap_layer$weights_fs_glsl")),_maxVs=module(require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$heatmap_layer$max_vs_glsl")),_maxFs=module(require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$heatmap_layer$max_fs_glsl")),_parameters,TEXTURE_OPTIONS={mipmaps:!1,parameters:(_parameters={},(0,_defineProperty2["default"])(_parameters,10240,9729),(0,_defineProperty2["default"])(_parameters,
10241,9729),(0,_defineProperty2["default"])(_parameters,10242,33071),(0,_defineProperty2["default"])(_parameters,10243,33071),_parameters),dataFormat:6408},DEFAULT_COLOR_DOMAIN=[0,0],AGGREGATION_MODE={SUM:0,MEAN:1};require={getPosition:{type:"accessor",value:function(x){return x.position}},getWeight:{type:"accessor",value:1},intensity:{type:"number",min:0,value:1},radiusPixels:{type:"number",min:1,max:100,value:50},colorRange:_colorUtils.defaultColorRange,threshold:{type:"number",min:0,max:1,value:.05},
colorDomain:{type:"array",value:null,optional:!0},aggregation:"SUM"};var REQUIRED_FEATURES=[_core.FEATURES.BLEND_EQUATION_MINMAX,_core.FEATURES.TEXTURE_FLOAT],DIMENSIONS={data:{props:["radiusPixels"]}};_parameters=function(_AggregationLayer){function HeatmapLayer(){(0,_classCallCheck2["default"])(this,HeatmapLayer);return _super.apply(this,arguments)}(0,_inherits2["default"])(HeatmapLayer,_AggregationLayer);var _super=_createSuper(HeatmapLayer);(0,_createClass2["default"])(HeatmapLayer,[{key:"initializeState",
value:function(){var gl=this.context.gl;(0,_core.hasFeatures)(gl,REQUIRED_FEATURES)?((0,_get2["default"])((0,_getPrototypeOf2["default"])(HeatmapLayer.prototype),"initializeState",this).call(this,DIMENSIONS),this.setState({supported:!0}),this._setupTextureParams(),this._setupAttributes(),this._setupResources()):(this.setState({supported:!1}),_core2.log.error("HeatmapLayer: ".concat(this.id," is not supported on this browser"))())}},{key:"shouldUpdateState",value:function(_ref){return _ref.changeFlags.somethingChanged}},
{key:"updateState",value:function(opts){if(this.state.supported){(0,_get2["default"])((0,_getPrototypeOf2["default"])(HeatmapLayer.prototype),"updateState",this).call(this,opts);var props=opts.props,oldProps=opts.oldProps,changeFlags=this._getChangeFlags(opts);changeFlags.viewportChanged&&(changeFlags.boundsChanged=this._updateBounds(),this._updateTextureRenderingBounds());changeFlags.dataChanged||changeFlags.boundsChanged?(clearTimeout(this.state.updateTimer),this.setState({isWeightMapDirty:!0})):
changeFlags.viewportZoomChanged&&this._debouncedUpdateWeightmap();props.colorRange!==oldProps.colorRange&&this._updateColorTexture(opts);if(oldProps.colorDomain!==props.colorDomain||changeFlags.viewportChanged){changeFlags=this.context.viewport;oldProps=this.state.weightsScale;var domainScale=(changeFlags?1024/changeFlags.scale:1)*oldProps;props=props.colorDomain?props.colorDomain.map(function(x){return x*domainScale}):DEFAULT_COLOR_DOMAIN;0<props[1]&&1>oldProps&&(oldProps=Math.min(props[1],1),props[0]*=
oldProps/props[1],props[1]=oldProps);this.setState({colorDomain:props})}this.state.isWeightMapDirty&&this._updateWeightmap();this.setState({zoom:opts.context.viewport.zoom})}}},{key:"renderLayers",value:function(){if(!this.state.supported)return[];var _this$state=this.state,weightsTexture=_this$state.weightsTexture,triPositionBuffer=_this$state.triPositionBuffer,triTexCoordBuffer=_this$state.triTexCoordBuffer,maxWeightsTexture=_this$state.maxWeightsTexture,colorTexture=_this$state.colorTexture;_this$state=
_this$state.colorDomain;var _this$props=this.props,updateTriggers=_this$props.updateTriggers,intensity=_this$props.intensity,threshold=_this$props.threshold;_this$props=_this$props.aggregation;return new (this.getSubLayerClass("triangle",_triangleLayer["default"]))(this.getSubLayerProps({id:"triangle-layer",updateTriggers}),{data:{attributes:{positions:triPositionBuffer,texCoords:triTexCoordBuffer}},vertexCount:4,maxTexture:maxWeightsTexture,colorTexture,aggregationMode:AGGREGATION_MODE[_this$props]||
0,texture:weightsTexture,intensity,threshold,colorDomain:_this$state})}},{key:"finalizeState",value:function(){(0,_get2["default"])((0,_getPrototypeOf2["default"])(HeatmapLayer.prototype),"finalizeState",this).call(this);var _this$state2=this.state,weightsTransform=_this$state2.weightsTransform,weightsTexture=_this$state2.weightsTexture,maxWeightTransform=_this$state2.maxWeightTransform,maxWeightsTexture=_this$state2.maxWeightsTexture,triPositionBuffer=_this$state2.triPositionBuffer,triTexCoordBuffer=
_this$state2.triTexCoordBuffer,colorTexture=_this$state2.colorTexture;_this$state2=_this$state2.updateTimer;weightsTransform&&weightsTransform["delete"]();weightsTexture&&weightsTexture["delete"]();maxWeightTransform&&maxWeightTransform["delete"]();maxWeightsTexture&&maxWeightsTexture["delete"]();triPositionBuffer&&triPositionBuffer["delete"]();triTexCoordBuffer&&triTexCoordBuffer["delete"]();colorTexture&&colorTexture["delete"]();_this$state2&&clearTimeout(_this$state2)}},{key:"_getAttributeManager",
value:function(){return new _core2.AttributeManager(this.context.gl,{id:this.props.id,stats:this.context.stats})}},{key:"_getChangeFlags",value:function(opts){var changeFlags={},dimensions=this.state.dimensions;changeFlags.dataChanged=this.isAttributeChanged()||this.isAggregationDirty(opts,{compareAll:!0,dimension:dimensions.data});changeFlags.viewportChanged=opts.changeFlags.viewportChanged;dimensions=this.state.zoom;opts.context.viewport&&opts.context.viewport.zoom===dimensions||(changeFlags.viewportZoomChanged=
!0);return changeFlags}},{key:"_createTextures",value:function(){var gl=this.context.gl,_this$state3=this.state,textureSize=_this$state3.textureSize,format=_this$state3.format;_this$state3=_this$state3.type;this.setState({weightsTexture:new _core.Texture2D(gl,_objectSpread({width:textureSize,height:textureSize,format,type:_this$state3},TEXTURE_OPTIONS)),maxWeightsTexture:new _core.Texture2D(gl,_objectSpread({format,type:_this$state3},TEXTURE_OPTIONS))})}},{key:"_setupAttributes",value:function(){this.getAttributeManager().add({positions:{size:3,
accessor:"getPosition"},weights:{size:1,accessor:"getWeight"}});this.setState({positionAttributeName:"positions"})}},{key:"_setupTextureParams",value:function(){var gl=this.context.gl,textureSize=Math.min(2048,(0,_core.getParameters)(gl,3379)),floatTargetSupport=(0,_core.hasFeatures)(gl,_core.FEATURES.COLOR_ATTACHMENT_RGBA32F);gl=(0,_heatmapLayerUtils.getTextureParams)({gl,floatTargetSupport});this.setState({textureSize,format:gl.format,type:gl.type,weightsScale:floatTargetSupport?1:1/255});floatTargetSupport||
_core2.log.warn("HeatmapLayer: ".concat(this.id," rendering to float texture not supported, fallingback to low precession format"))()}},{key:"_createWeightsTransform",value:function(){var shaderOptions=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},gl=this.context.gl,weightsTransform=this.state.weightsTransform,weightsTexture=this.state.weightsTexture;if(weightsTransform)weightsTransform["delete"]();shaderOptions=(0,_core2._mergeShaders)({vs:_weightsVs["default"],_fs:_weightsFs["default"],
modules:[_core2.project32]},shaderOptions);weightsTransform=new _core.Transform(gl,_objectSpread({id:"".concat(this.id,"-weights-transform"),elementCount:1,_targetTexture:weightsTexture,_targetTextureVarying:"weightsTexture"},shaderOptions));this.setState({weightsTransform})}},{key:"_setupResources",value:function(){var gl=this.context.gl;this._createTextures();var _this$state4=this.state,textureSize=_this$state4.textureSize,weightsTexture=_this$state4.weightsTexture;_this$state4=_this$state4.maxWeightsTexture;
this._createWeightsTransform();textureSize=new _core.Transform(gl,{id:"".concat(this.id,"-max-weights-transform"),_sourceTextures:{inTexture:weightsTexture},_targetTexture:_this$state4,_targetTextureVarying:"outTexture",vs:_maxVs["default"],_fs:_maxFs["default"],elementCount:textureSize*textureSize});this.setState({weightsTexture,maxWeightsTexture:_this$state4,maxWeightTransform:textureSize,zoom:null,triPositionBuffer:new _core.Buffer(gl,{byteLength:48,accessor:{size:3}}),triTexCoordBuffer:new _core.Buffer(gl,
{byteLength:48,accessor:{size:2}})})}},{key:"updateShaders",value:function(shaderOptions){this._createWeightsTransform(shaderOptions)}},{key:"_updateMaxWeightValue",value:function(){this.state.maxWeightTransform.run({parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32776}})}},{key:"_updateBounds",value:function(){var forceUpdate=0<arguments.length&&void 0!==arguments[0]?arguments[0]:!1,viewport=this.context.viewport;viewport=[viewport.unproject([0,0]),viewport.unproject([viewport.width,
0]),viewport.unproject([viewport.width,viewport.height]),viewport.unproject([0,viewport.height])];var visibleWorldBounds=(0,_heatmapLayerUtils.getBounds)(viewport);viewport={visibleWorldBounds,viewportCorners:viewport};var boundsChanged=!1;!forceUpdate&&this.state.worldBounds&&(0,_heatmapLayerUtils.boundsContain)(this.state.worldBounds,visibleWorldBounds)||(forceUpdate=this._worldToCommonBounds(visibleWorldBounds),forceUpdate=this._commonToWorldBounds(forceUpdate),this.props.coordinateSystem===_core2.COORDINATE_SYSTEM.LNGLAT&&
(forceUpdate[1]=Math.max(forceUpdate[1],-85.051129),forceUpdate[3]=Math.min(forceUpdate[3],85.051129),forceUpdate[0]=Math.max(forceUpdate[0],-360),forceUpdate[2]=Math.min(forceUpdate[2],360)),visibleWorldBounds=this._worldToCommonBounds(forceUpdate),viewport.worldBounds=forceUpdate,viewport.normalizedCommonBounds=visibleWorldBounds,boundsChanged=!0);this.setState(viewport);return boundsChanged}},{key:"_updateTextureRenderingBounds",value:function(){var _this$state5=this.state,triTexCoordBuffer=_this$state5.triTexCoordBuffer,
normalizedCommonBounds=_this$state5.normalizedCommonBounds,viewportCorners=_this$state5.viewportCorners,viewport=this.context.viewport;_this$state5.triPositionBuffer.subData((0,_heatmapLayerUtils.packVertices)(viewportCorners,3));_this$state5=viewportCorners.map(function(p){return(0,_heatmapLayerUtils.getTextureCoordinates)(viewport.projectPosition(p),normalizedCommonBounds)});triTexCoordBuffer.subData((0,_heatmapLayerUtils.packVertices)(_this$state5,2))}},{key:"_updateColorTexture",value:function(opts){opts=
opts.props.colorRange;var colorTexture=this.state.colorTexture,colors=(0,_colorUtils.colorRangeToFlatArray)(opts,!1,Uint8Array);colorTexture?colorTexture.setImageData({data:colors,width:opts.length}):colorTexture=new _core.Texture2D(this.context.gl,_objectSpread({data:colors,width:opts.length,height:1},TEXTURE_OPTIONS));this.setState({colorTexture})}},{key:"_updateWeightmap",value:function(){var _weightsTexture$setPa,radiusPixels=this.props.radiusPixels,_this$state6=this.state,weightsTransform=_this$state6.weightsTransform,
worldBounds=_this$state6.worldBounds,textureSize=_this$state6.textureSize,weightsTexture=_this$state6.weightsTexture;_this$state6=_this$state6.weightsScale;this.state.isWeightMapDirty=!1;worldBounds=this._worldToCommonBounds(worldBounds,{useLayerCoordinateSystem:!0});radiusPixels={radiusPixels,commonBounds:worldBounds,textureWidth:textureSize,weightsScale:_this$state6};weightsTransform.update({elementCount:this.getNumInstances()});weightsTransform.run({uniforms:radiusPixels,parameters:{blend:!0,depthTest:!1,
blendFunc:[1,1],blendEquation:32774},clearRenderTarget:!0,attributes:this.getAttributes(),moduleSettings:this.getModuleSettings()});this._updateMaxWeightValue();weightsTexture.setParameters((_weightsTexture$setPa={},(0,_defineProperty2["default"])(_weightsTexture$setPa,10240,9729),(0,_defineProperty2["default"])(_weightsTexture$setPa,10241,9729),_weightsTexture$setPa))}},{key:"_debouncedUpdateWeightmap",value:function(){var updateTimer=this.state.updateTimer;0<arguments.length&&void 0!==arguments[0]&&
arguments[0]?(updateTimer=null,this._updateBounds(!0),this._updateTextureRenderingBounds(),this.setState({isWeightMapDirty:!0})):(this.setState({isWeightMapDirty:!1}),clearTimeout(updateTimer),updateTimer=setTimeout(this._debouncedUpdateWeightmap.bind(this,!0),500));this.setState({updateTimer})}},{key:"_worldToCommonBounds",value:function(worldBounds){var _opts$useLayerCoordin=(1<arguments.length&&void 0!==arguments[1]?arguments[1]:{}).useLayerCoordinateSystem,useLayerCoordinateSystem=void 0===_opts$useLayerCoordin?
!1:_opts$useLayerCoordin;_opts$useLayerCoordin=(0,_slicedToArray2["default"])(worldBounds,4);var minLong=_opts$useLayerCoordin[0],minLat=_opts$useLayerCoordin[1],maxLong=_opts$useLayerCoordin[2],maxLat=_opts$useLayerCoordin[3],viewport=this.context.viewport;_opts$useLayerCoordin=2*this.state.textureSize/viewport.scale;useLayerCoordinateSystem?(useLayerCoordinateSystem=this.projectPosition([minLong,minLat,0]),maxLong=this.projectPosition([maxLong,maxLat,0])):(useLayerCoordinateSystem=viewport.projectPosition([minLong,
minLat,0]),maxLong=viewport.projectPosition([maxLong,maxLat,0]));maxLong=useLayerCoordinateSystem.slice(0,2).concat(maxLong.slice(0,2));return maxLong=(0,_heatmapLayerUtils.scaleToAspectRatio)(maxLong,_opts$useLayerCoordin,_opts$useLayerCoordin)}},{key:"_commonToWorldBounds",value:function(commonBounds){var _commonBounds=(0,_slicedToArray2["default"])(commonBounds,4);commonBounds=_commonBounds[2];var yMax=_commonBounds[3],viewport=this.context.viewport;_commonBounds=viewport.unprojectPosition([_commonBounds[0],
_commonBounds[1]]);commonBounds=viewport.unprojectPosition([commonBounds,yMax]);return _commonBounds.slice(0,2).concat(commonBounds.slice(0,2))}}]);return HeatmapLayer}(global["default"]);exports["default"]=_parameters;_parameters.layerName="HeatmapLayer";_parameters.defaultProps=require}
//# sourceMappingURL=module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$heatmap_layer$heatmap_layer.js.map
