shadow$provide.module$node_modules$$luma_DOT_gl$engine$dist$es5$lib$animation_loop=function(global,require,module,exports){global=require("module$node_modules$$babel$runtime$helpers$interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0});exports["default"]=void 0;var _typeof2=global(require("module$node_modules$$babel$runtime$helpers$typeof")),_regenerator=global(require("module$node_modules$$babel$runtime$regenerator$index")),_asyncToGenerator2=global(require("module$node_modules$$babel$runtime$helpers$asyncToGenerator")),
_classCallCheck2=global(require("module$node_modules$$babel$runtime$helpers$classCallCheck")),_createClass2=global(require("module$node_modules$$babel$runtime$helpers$createClass")),_gltools=require("module$node_modules$$luma_DOT_gl$gltools$dist$es5$index"),_webgl=require("module$node_modules$$luma_DOT_gl$webgl$dist$es5$index");require=require("module$node_modules$probe_DOT_gl$env");var isPage=(0,require.isBrowser)()&&"undefined"!==typeof document,statIdCounter=0;require=function(){function AnimationLoop(){var props=
0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};(0,_classCallCheck2["default"])(this,AnimationLoop);var _props$onCreateContex=props.onCreateContext;_props$onCreateContex=void 0===_props$onCreateContex?function(opts){return(0,_gltools.createGLContext)(opts)}:_props$onCreateContex;var _props$onAddHTML=props.onAddHTML;_props$onAddHTML=void 0===_props$onAddHTML?null:_props$onAddHTML;var _props$onInitialize=props.onInitialize;_props$onInitialize=void 0===_props$onInitialize?function(){}:_props$onInitialize;
var _props$onRender=props.onRender;_props$onRender=void 0===_props$onRender?function(){}:_props$onRender;var _props$onFinalize=props.onFinalize;_props$onFinalize=void 0===_props$onFinalize?function(){}:_props$onFinalize;var onError=props.onError,_props$gl=props.gl;_props$gl=void 0===_props$gl?null:_props$gl;var _props$glOptions=props.glOptions;_props$glOptions=void 0===_props$glOptions?{}:_props$glOptions;var _props$debug=props.debug;_props$debug=void 0===_props$debug?!1:_props$debug;var _props$createFramebuf=
props.createFramebuffer;_props$createFramebuf=void 0===_props$createFramebuf?!1:_props$createFramebuf;var _props$autoResizeView=props.autoResizeViewport;_props$autoResizeView=void 0===_props$autoResizeView?!0:_props$autoResizeView;var _props$autoResizeDraw=props.autoResizeDrawingBuffer;_props$autoResizeDraw=void 0===_props$autoResizeDraw?!0:_props$autoResizeDraw;var _props$stats=props.stats;_props$stats=void 0===_props$stats?_webgl.lumaStats.get("animation-loop-".concat(statIdCounter++)):_props$stats;
var _props$useDevicePixel=props.useDevicePixels;_props$useDevicePixel=void 0===_props$useDevicePixel?!0:_props$useDevicePixel;"useDevicePixelRatio"in props&&(_webgl.log.deprecated("useDevicePixelRatio","useDevicePixels")(),_props$useDevicePixel=props.useDevicePixelRatio);this.props={onCreateContext:_props$onCreateContex,onAddHTML:_props$onAddHTML,onInitialize:_props$onInitialize,onRender:_props$onRender,onFinalize:_props$onFinalize,onError,gl:_props$gl,glOptions:_props$glOptions,debug:_props$debug,
createFramebuffer:_props$createFramebuf};this.gl=_props$gl;this.timeline=this.needsRedraw=null;this.stats=_props$stats;this.cpuTime=this.stats.get("CPU Time");this.gpuTime=this.stats.get("GPU Time");this.frameRate=this.stats.get("Frame Rate");this._running=this._initialized=!1;this._resolveNextFrame=this._nextFramePromise=this._animationFrameId=null;this._cpuStartTime=0;this.setProps({autoResizeViewport:_props$autoResizeView,autoResizeDrawingBuffer:_props$autoResizeDraw,useDevicePixels:_props$useDevicePixel});
this.start=this.start.bind(this);this.stop=this.stop.bind(this);this._pageLoadPromise=null;this._onMousemove=this._onMousemove.bind(this);this._onMouseleave=this._onMouseleave.bind(this)}(0,_createClass2["default"])(AnimationLoop,[{key:"delete",value:function(){this.stop();this._setDisplay(null)}},{key:"setNeedsRedraw",value:function(reason){(0,_webgl.assert)("string"===typeof reason);this.needsRedraw=this.needsRedraw||reason;return this}},{key:"setProps",value:function(props){"autoResizeViewport"in
props&&(this.autoResizeViewport=props.autoResizeViewport);"autoResizeDrawingBuffer"in props&&(this.autoResizeDrawingBuffer=props.autoResizeDrawingBuffer);"useDevicePixels"in props&&(this.useDevicePixels=props.useDevicePixels);return this}},{key:"start",value:function(){var _this=this,opts=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(this._running)return this;this._running=!0;var startPromise=this._getPageLoadPromise().then(function(){if(!_this._running||_this._initialized)return null;
_this._createWebGLContext(opts);_this._createFramebuffer();_this._startEventHandling();_this._initializeCallbackData();_this._updateCallbackData();_this._resizeCanvasDrawingBuffer();_this._resizeViewport();_this._gpuTimeQuery=_webgl.Query.isSupported(_this.gl,["timers"])?new _webgl.Query(_this.gl):null;_this._initialized=!0;return _this.onInitialize(_this.animationProps)}).then(function(appContext){_this._running&&(_this._addCallbackData(appContext||{}),!1!==appContext&&_this._startLoop())});if(this.props.onError)startPromise["catch"](this.props.onError);
return this}},{key:"redraw",value:function(){if(this.isContextLost())return this;this._beginTimers();this._setupFrame();this._updateCallbackData();this._renderFrame(this.animationProps);this._clearNeedsRedraw();this.offScreen&&this.gl.commit&&this.gl.commit();this._resolveNextFrame&&(this._resolveNextFrame(this),this._resolveNextFrame=this._nextFramePromise=null);this._endTimers();return this}},{key:"stop",value:function(){this._running&&(this._finalizeCallbackData(),(0,_webgl.cancelAnimationFrame)(this._animationFrameId),
this._animationFrameId=this._resolveNextFrame=this._nextFramePromise=null,this._running=!1);return this}},{key:"attachTimeline",value:function(timeline){return this.timeline=timeline}},{key:"detachTimeline",value:function(){this.timeline=null}},{key:"waitForRender",value:function(){var _this2=this;this.setNeedsRedraw("waitForRender");this._nextFramePromise||(this._nextFramePromise=new Promise(function(resolve){_this2._resolveNextFrame=resolve}));return this._nextFramePromise}},{key:"toDataURL",value:function(){var _toDataURL=
(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(){return _regenerator["default"].wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:return this.setNeedsRedraw("toDataURL"),_context.next=3,this.waitForRender();case 3:return _context.abrupt("return",this.gl.canvas.toDataURL());case 4:case "end":return _context.stop()}},_callee,this)}));return function(){return _toDataURL.apply(this,arguments)}}()},{key:"isContextLost",value:function(){return this.gl.isContextLost()}},
{key:"onCreateContext",value:function(){var _this$props;return(_this$props=this.props).onCreateContext.apply(_this$props,arguments)}},{key:"onInitialize",value:function(){var _this$props2;return(_this$props2=this.props).onInitialize.apply(_this$props2,arguments)}},{key:"onRender",value:function(){var _this$props3;return(_this$props3=this.props).onRender.apply(_this$props3,arguments)}},{key:"onFinalize",value:function(){var _this$props4;return(_this$props4=this.props).onFinalize.apply(_this$props4,
arguments)}},{key:"getHTMLControlValue",value:function(id){var defaultValue=1<arguments.length&&void 0!==arguments[1]?arguments[1]:1,element=document.getElementById(id);return element?Number(element.value):defaultValue}},{key:"setViewParameters",value:function(){_webgl.log.removed("AnimationLoop.setViewParameters","AnimationLoop.setProps")();return this}},{key:"_startLoop",value:function(){var _this3=this;(0,_webgl.cancelAnimationFrame)(this._animationFrameId);this._animationFrameId=this._requestAnimationFrame(function renderFrame(){_this3._running&&
(_this3.redraw(),_this3._animationFrameId=_this3._requestAnimationFrame(renderFrame))})}},{key:"_getPageLoadPromise",value:function(){this._pageLoadPromise||(this._pageLoadPromise=isPage?new Promise(function(resolve,reject){isPage&&"complete"===document.readyState?resolve(document):window.addEventListener("load",function(){resolve(document)})}):Promise.resolve({}));return this._pageLoadPromise}},{key:"_setDisplay",value:function(display){this.display&&(this.display["delete"](),this.display.animationLoop=
null);display&&(display.animationLoop=this);this.display=display}},{key:"_requestAnimationFrame",value:function(renderFrameCallback){this.display&&this.display.requestAnimationFrame(renderFrameCallback)||(0,_webgl.requestAnimationFrame)(renderFrameCallback)}},{key:"_renderFrame",value:function(){if(this.display){var _this$display;(_this$display=this.display)._renderFrame.apply(_this$display,arguments)}else this.onRender.apply(this,arguments)}},{key:"_clearNeedsRedraw",value:function(){this.needsRedraw=
null}},{key:"_setupFrame",value:function(){this._resizeCanvasDrawingBuffer();this._resizeViewport();this._resizeFramebuffer()}},{key:"_initializeCallbackData",value:function(){this.animationProps={gl:this.gl,stop:this.stop,canvas:this.gl.canvas,framebuffer:this.framebuffer,useDevicePixels:this.useDevicePixels,needsRedraw:null,startTime:Date.now(),engineTime:0,tick:0,tock:0,time:0,_timeline:this.timeline,_loop:this,_animationLoop:this,_mousePosition:null}}},{key:"_updateCallbackData",value:function(){var _this$_getSizeAndAspe=
this._getSizeAndAspect(),width=_this$_getSizeAndAspe.width,height=_this$_getSizeAndAspe.height;_this$_getSizeAndAspe=_this$_getSizeAndAspe.aspect;width===this.animationProps.width&&height===this.animationProps.height||this.setNeedsRedraw("drawing buffer resized");_this$_getSizeAndAspe!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed");this.animationProps.width=width;this.animationProps.height=height;this.animationProps.aspect=_this$_getSizeAndAspe;this.animationProps.needsRedraw=
this.needsRedraw;this.animationProps.engineTime=Date.now()-this.animationProps.startTime;this.timeline&&this.timeline.update(this.animationProps.engineTime);this.animationProps.tick=Math.floor(this.animationProps.time/1E3*60);this.animationProps.tock++;this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime;this.animationProps._offScreen=this.offScreen}},{key:"_finalizeCallbackData",value:function(){this.onFinalize(this.animationProps)}},{key:"_addCallbackData",
value:function(appContext){"object"===(0,_typeof2["default"])(appContext)&&null!==appContext&&(this.animationProps=Object.assign({},this.animationProps,appContext))}},{key:"_createWebGLContext",value:function(opts){this.offScreen=opts.canvas&&"undefined"!==typeof OffscreenCanvas&&opts.canvas instanceof OffscreenCanvas;opts=Object.assign({},opts,this.props.glOptions);this.gl=this.props.gl?(0,_gltools.instrumentGLContext)(this.props.gl,opts):this.onCreateContext(opts);if(!(0,_gltools.isWebGL)(this.gl))throw Error("AnimationLoop.onCreateContext - illegal context returned");
(0,_gltools.resetParameters)(this.gl);this._createInfoDiv()}},{key:"_createInfoDiv",value:function(){if(this.gl.canvas&&this.props.onAddHTML){var wrapperDiv=document.createElement("div");document.body.appendChild(wrapperDiv);wrapperDiv.style.position="relative";var div=document.createElement("div");div.style.position="absolute";div.style.left="10px";div.style.bottom="10px";div.style.width="300px";div.style.background="white";wrapperDiv.appendChild(this.gl.canvas);wrapperDiv.appendChild(div);if(wrapperDiv=
this.props.onAddHTML(div))div.innerHTML=wrapperDiv}}},{key:"_getSizeAndAspect",value:function(){var width=this.gl.drawingBufferWidth,height=this.gl.drawingBufferHeight,aspect=1,canvas=this.gl.canvas;canvas&&canvas.clientHeight?aspect=canvas.clientWidth/canvas.clientHeight:0<width&&0<height&&(aspect=width/height);return{width,height,aspect}}},{key:"_resizeViewport",value:function(){this.autoResizeViewport&&this.gl.viewport(0,0,this.gl.drawingBufferWidth,this.gl.drawingBufferHeight)}},{key:"_resizeCanvasDrawingBuffer",
value:function(){this.autoResizeDrawingBuffer&&(0,_gltools.resizeGLContext)(this.gl,{useDevicePixels:this.useDevicePixels})}},{key:"_createFramebuffer",value:function(){this.props.createFramebuffer&&(this.framebuffer=new _webgl.Framebuffer(this.gl))}},{key:"_resizeFramebuffer",value:function(){this.framebuffer&&this.framebuffer.resize({width:this.gl.drawingBufferWidth,height:this.gl.drawingBufferHeight})}},{key:"_beginTimers",value:function(){this.frameRate.timeEnd();this.frameRate.timeStart();this._gpuTimeQuery&&
this._gpuTimeQuery.isResultAvailable()&&!this._gpuTimeQuery.isTimerDisjoint()&&this.stats.get("GPU Time").addTime(this._gpuTimeQuery.getTimerMilliseconds());this._gpuTimeQuery&&this._gpuTimeQuery.beginTimeElapsedQuery();this.cpuTime.timeStart()}},{key:"_endTimers",value:function(){this.cpuTime.timeEnd();this._gpuTimeQuery&&this._gpuTimeQuery.end()}},{key:"_startEventHandling",value:function(){var canvas=this.gl.canvas;canvas&&(canvas.addEventListener("mousemove",this._onMousemove),canvas.addEventListener("mouseleave",
this._onMouseleave))}},{key:"_onMousemove",value:function(e){this.animationProps._mousePosition=[e.offsetX,e.offsetY]}},{key:"_onMouseleave",value:function(e){this.animationProps._mousePosition=null}}]);return AnimationLoop}();exports["default"]=require}
//# sourceMappingURL=module$node_modules$$luma_DOT_gl$engine$dist$es5$lib$animation_loop.js.map
