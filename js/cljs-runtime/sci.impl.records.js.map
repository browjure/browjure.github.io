{"version":3,"sources":["sci/impl/records.cljc"],"mappings":"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C,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAAH,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAAH,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAAH,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAAC,AAAA,AAAAJ,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAAH,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAAH,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAAC,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAA,AAAAA,AAAA,AAAA,AAAA,A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","names":["var_args","args__4742__auto__","len__4736__auto__","i__4737__auto__","argseq__4743__auto__","cljs.core/IndexedSeq","sci.impl.records/defrecord","seq64613","G__64617","cljs.core/first","cljs.core/next","G__64618","G__64619","G__64620","G__64621","self__4723__auto__","_","ctx","record-name","fields","protocol-impls","cljs.core.sequence","cljs.core/seq","cljs.core.concat","cljs.core/List","cljs.core/vec","cljs.core.apply","cljs.core/array-map","factory-fn-str","factory-fn-sym","cljs.core.symbol","map-factory-sym","keys","cljs.core.mapv","cljs.core/keyword","rec-type","sci.impl.vars/current-ns-name","sci.impl.utils/split-when","cljs.core/symbol?","field-set","cljs.core/set","cljs.core.mapcat","p__64632","vec__64635","seq__64636","first__64637","protocol-name","impls","p1__64577#","cljs.core/group-by","protocol","fexpr__64646","cljs.core/deref","sci.impl.utils/eval-resolve-state","sci.impl.vars/var?","protocol-ns","pns","sci.impl.vars/getName","fq-meth-name","cljs.core.map","p__64652","vec__64653","cljs.core.nth","method-name","bodies","cljs.core/rest","impl","args","body","destr","sci.impl.utils/maybe-destructured","this","bindings","field","cljs.core.keyword","cljs.core.reduce","cljs.core/disj","sci.impl.records/sci-record?","x","or__4126__auto__","cljs.core/map?","G__64746","cljs.core/meta","cljs.core/record?","G__64759","sci.impl.records/resolve-record-or-protocol-class","js/Error","sym","sym-str","last-dot","clojure.string.last_index_of","class-name","cljs.core.subs","namespace","sci.impl.records.resolve_record_or_protocol_class","package","class","clojure.string/replace","temp__5753__auto__","sci-var","cljs.core.get_in","sci.impl.records/resolve-record-class","class-sym","cljs.core/Symbol"],"sourcesContent":["(ns sci.impl.records\n  {:no-doc true}\n  (:refer-clojure :exclude [defrecord record?])\n  (:require [clojure.string :as str]\n            [sci.impl.utils :as utils]\n            [sci.impl.vars :as vars]))\n\n(defn defrecord [_ _ ctx record-name fields & protocol-impls]\n  (let [factory-fn-str (str \"->\" record-name)\n        factory-fn-sym (symbol factory-fn-str)\n        map-factory-sym (symbol (str \"map\" factory-fn-str))\n        keys (mapv keyword fields)\n        rec-type (symbol (str (vars/current-ns-name)) (str record-name))\n        protocol-impls (utils/split-when symbol? protocol-impls)\n        field-set (set fields)\n        protocol-impls\n        (mapcat\n         (fn [[protocol-name & impls]]\n           (let [impls (group-by first impls)\n                 protocol (@utils/eval-resolve-state ctx protocol-name)\n                 protocol (if (vars/var? protocol) @protocol protocol)\n                 protocol-ns (:ns protocol)\n                 pns (str (vars/getName protocol-ns))\n                 fq-meth-name #(symbol pns %)]\n             (map (fn [[method-name bodies]]\n                    (let [bodies (map rest bodies)\n                          bodies (mapv (fn [impl]\n                                         (let [args (first impl)\n                                               body (rest impl)\n                                               destr (utils/maybe-destructured args body)\n                                               args (:params destr)\n                                               body (:body destr)\n                                               this (first args)\n                                               bindings\n                                               (vec (mapcat (fn [field]\n                                                              [field (list (keyword field) this)])\n                                                            (reduce disj field-set args)))]\n                                           `(~args\n                                             (let ~bindings\n                                               ~@body)))) bodies)]\n                      `(defmethod ~(fq-meth-name (str method-name)) '~rec-type ~@bodies)))\n                  impls)))\n         protocol-impls)]\n    `(do\n       (defn ~map-factory-sym [m#]\n         (vary-meta m#\n                    assoc\n                    :sci.impl/record true\n                    :type '~rec-type))\n       (defn ~factory-fn-sym [& args#]\n         (vary-meta (zipmap ~keys args#)\n                    assoc\n                    :sci.impl/record true\n                    :type '~rec-type))\n       (def ~record-name (with-meta '~rec-type\n                           {:sci.impl/record true\n                            :sci.impl.record/constructor ~factory-fn-sym}))\n       ~@protocol-impls)))\n\n(defn sci-record? [x]\n  (or\n   (when (map? x)\n     (some-> x meta :sci.impl/record))\n   (clojure.core/record? x)))\n\n(defn resolve-record-or-protocol-class\n  \"A record class is represented by a symbol with metadata (currently). This is only an implementation detail.\n   A protocol is represented by a map with :ns, :methods and optionally :class. This is also an implementation detail.\"\n  ;; TODO: we should probably use munging here for namespaces with hyphens in them.\n  ([ctx sym]\n   (let [sym-str (str sym)\n         last-dot (str/last-index-of sym-str \".\")\n         class-name (if last-dot\n                      (subs sym-str (inc last-dot) (count sym-str))\n                      sym-str)\n         namespace (if last-dot\n                     (symbol (subs sym-str 0 last-dot))\n                     (vars/current-ns-name))]\n     (resolve-record-or-protocol-class ctx namespace (symbol class-name))))\n  ([ctx package class]\n   (let [namespace (-> package str (str/replace \"_\" \"-\") symbol)]\n     (when-let [sci-var (get-in @(:env ctx) [:namespaces namespace class])]\n       (if (vars/var? sci-var)\n         @sci-var\n         sci-var)))))\n\n(defn resolve-record-class\n  [ctx class-sym]\n  (when-let [x (resolve-record-or-protocol-class ctx class-sym)]\n    (when (symbol? x) x)))\n"]}