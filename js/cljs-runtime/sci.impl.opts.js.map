{"version":3,"sources":["sci/impl/opts.cljc"],"mappings":"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","names":["sci.impl.opts/init-env!","env","bindings","aliases","namespaces","imports","load-fn","cljs.core.swap_BANG_","cljs.core.merge_with","cljs.core/merge","sci.impl.namespaces/namespaces","cljs.core.assoc","sci.impl.vars/user-ns","cljs.core.merge","sci.impl.namespaces/aliases","cljs.core.get_in","cljs.core.update","cljs.core/assoc","sci.impl.vars/->SciVar","cljs.core/make-hierarchy","temp__5751__auto__","env-imports","cljs.core/not","var_args","args__4742__auto__","len__4736__auto__","i__4737__auto__","argseq__4743__auto__","cljs.core/IndexedSeq","sci.impl.opts/process-permissions","seq85460","G__85461","cljs.core/first","cljs.core/next","self__4723__auto__","prev-perms","permissions","cljs.core/not-empty","cljs.core.into","cljs.core.comp","cljs.core/cat","cljs.core.map","sci.impl.utils/strip-core-ns","p1__85473#","p1__85475#","sci.impl.opts/default-classes","js/Error","msg","filename","line","cljs.core/Delay","goog.string/StringBuffer","sci.impl.opts/default-imports","sci.impl.opts/normalize-classes","classes","class->opts","cljs.core/transient","cljs.core/select-keys","kvs","vec__85481","cljs.core.nth","sym","class-opts","cljs.core.assoc_BANG_","cljs.core/map?","cljs.core/rest","cljs.core/persistent!","sci.impl.opts/default-reify","sci.impl.opts/->ctx","features","readers","p__85486","map__85487","cljs.core/PROTOCOL_SENTINEL","cljs.core.apply","cljs.core/hash-map","cljs.core.get","reify","disable-arity-checks","allow","uberscript","deny","sci.impl.opts/init","or__4126__auto__","cljs.core.atom","_","raw-classes","ctx","sci.impl.opts.process_permissions","sci.impl.opts/merge-opts","opts","map__85493"],"sourcesContent":["(ns sci.impl.opts\n  {:no-doc true}\n  (:require\n   #?(:cljs [goog.string])\n   [sci.impl.namespaces :as namespaces]\n   [sci.impl.utils :as utils :refer [strip-core-ns]]\n   [sci.impl.vars :as vars]\n   [sci.lang]))\n\n#?(:clj\n   (defrecord Env [namespaces imports load-fn]))\n\n(defn init-env! [env bindings aliases namespaces imports load-fn]\n  (swap! env (fn [env]\n               (let [namespaces (merge-with merge\n                                            namespaces/namespaces\n                                            {'user (assoc bindings\n                                                          :obj vars/user-ns)}\n                                            namespaces\n                                            (:namespaces env))\n                     aliases (merge namespaces/aliases aliases\n                                    (get-in env [:namespaces 'user :aliases]))\n                     namespaces (-> namespaces\n                                    (update 'user assoc :aliases aliases)\n                                    (update 'clojure.core assoc 'global-hierarchy\n                                            (vars/->SciVar (make-hierarchy) 'global-hierarchy nil false)))\n                     imports (if-let [env-imports (:imports env)]\n                               (merge env-imports imports)\n                               imports)]\n                 ;; TODO: is the first case ever hit?\n                 (if-not env\n                   #?(:clj (->Env namespaces imports load-fn)\n                      :cljs {:namespaces namespaces\n                             :imports imports\n                             :load-fn load-fn})\n                   (assoc env\n                          :namespaces namespaces\n                          :imports imports\n                          :load-fn load-fn))))))\n\n(defn process-permissions [prev-perms & permissions]\n  (not-empty (into prev-perms (comp cat (map strip-core-ns)) permissions)))\n\n(def default-classes\n  #?(:clj {'java.lang.AssertionError AssertionError\n           'java.lang.Exception {:class Exception}\n           'java.lang.IllegalArgumentException java.lang.IllegalArgumentException\n           'clojure.lang.Delay clojure.lang.Delay\n           'clojure.lang.ExceptionInfo clojure.lang.ExceptionInfo\n           'clojure.lang.LineNumberingPushbackReader clojure.lang.LineNumberingPushbackReader\n           'java.lang.String {:class String}\n           'java.io.StringWriter java.io.StringWriter\n           'java.io.StringReader java.io.StringReader\n           'java.lang.Integer Integer\n           'java.lang.Number Number\n           'java.lang.Double Double\n           'java.lang.ArithmeticException ArithmeticException\n           'java.lang.Object Object\n           'sci.lang.IVar sci.lang.IVar}\n     :cljs {'Error {:class js/Error :constructor (fn\n                                                   ([msg] (js/Error. msg))\n                                                   ([msg filename] (js/Error. msg filename))\n                                                   ([msg filename line] (js/Error. msg filename line)))}\n            'cljs.core.Delay {:class cljs.core/Delay\n                              :constructor #(cljs.core/Delay. % nil)}\n            'goog.string.StringBuffer {:class goog.string/StringBuffer\n                                       :constructor #(goog.string/StringBuffer. %)}}))\n\n(def default-imports\n  #?(:clj '{AssertionError java.lang.AssertionError\n            Exception java.lang.Exception\n            String java.lang.String\n            ArithmeticException java.lang.ArithmeticException\n            Integer java.lang.Integer\n            Number java.lang.Number\n            Double java.lang.Double\n            Object java.lang.Object}\n     :cljs {}))\n\n(defn normalize-classes [classes]\n  (loop [class->opts (transient (select-keys classes [:allow]))\n         kvs classes]\n    (if-let [[sym class-opts] (first kvs)]\n      (recur ;; storing the physical class as key didn't work well with\n       ;; GraalVM\n       (assoc! class->opts sym (if (map? class-opts)\n                                 class-opts\n                                 {:class class-opts}))\n       (rest kvs))\n      {:public-class (:public-class classes)\n       :class->opts (persistent! class->opts)})))\n\n(def default-reify\n  #?(:clj {'#{java.lang.Object}\n           (fn [methods]\n             (reify Object\n               (toString [this]\n                 ((get-in methods '[java.lang.Object toString]) this))))}\n     :cljs {}))\n\n#?(:clj (defrecord Ctx [bindings env\n                        features readers]))\n\n(defn ->ctx [bindings env features readers]\n  #?(:cljs {:bindings bindings\n            :env env\n            :features features\n            :readers readers}\n     :clj (->Ctx bindings env features readers)))\n\n(defn init\n  \"Initializes options\"\n  [{:keys [:bindings :env\n           :allow :deny\n           :aliases\n           :namespaces\n           :classes\n           :imports\n           :features\n           :load-fn\n           :uberscript ;; used by babashka, not public!\n           :readers\n           :reify\n           :disable-arity-checks]}]\n  (let [env (or env (atom {}))\n        imports (merge default-imports imports)\n        bindings bindings\n        _ (init-env! env bindings aliases namespaces imports load-fn)\n        raw-classes classes\n        classes (normalize-classes (merge default-classes raw-classes))\n        ctx (assoc (->ctx {} env features readers)\n                   :allow (process-permissions #{} allow)\n                   :deny (process-permissions #{} deny)\n                   :uberscript uberscript\n                   :reify (merge default-reify reify)\n                   :disable-arity-checks disable-arity-checks\n                   :public-class (:public-class classes)\n                   :raw-classes raw-classes ;; hold on for merge-opts\n                   :class->opts (:class->opts classes))]\n    ctx))\n\n(defn merge-opts [ctx opts]\n  (let [{:keys [:bindings\n                :allow :deny\n                :aliases\n                :namespaces\n                :classes\n                :imports\n                :features\n                :load-fn\n                :uberscript ;; used by babashka, not public!\n                :readers\n                :reify\n                :disable-arity-checks]} opts\n        env (:env ctx)\n        _ (init-env! env bindings aliases namespaces imports load-fn)\n        raw-classes (merge (:raw-classes ctx) classes)\n        classes (normalize-classes raw-classes)\n        ctx (assoc (->ctx {} env features readers)\n                   :allow (process-permissions (:allow ctx) allow)\n                   :deny (process-permissions (:deny ctx) deny)\n                   :uberscript uberscript\n                   :reify (merge (:reify ctx) reify)\n                   :disable-arity-checks disable-arity-checks\n                   :public-class (:public-class classes)\n                   :raw-classes raw-classes\n                   :class->opts (:class->opts classes))]\n    ctx))\n"]}