shadow$provide.module$node_modules$$deck_DOT_gl$core$dist$es5$lib$deck_picker=function(global,require,module,exports){function _createForOfIteratorHelper(o,allowArrayLike){var it;if("undefined"===typeof Symbol||null==o[Symbol.iterator]){if(Array.isArray(o)||(it=_unsupportedIterableToArray(o))||allowArrayLike&&o&&"number"===typeof o.length){it&&(o=it);var i=0;allowArrayLike=function(){};return{s:allowArrayLike,n:function(){return i>=o.length?{done:!0}:{done:!1,value:o[i++]}},e:function(_e){throw _e;
},f:allowArrayLike}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");}var normalCompletion=!0,didErr=!1,err;return{s:function(){it=o[Symbol.iterator]()},n:function(){var step=it.next();normalCompletion=step.done;return step},e:function(_e2){didErr=!0;err=_e2},f:function(){try{if(!normalCompletion&&null!=it["return"])it["return"]()}finally{if(didErr)throw err;}}}}function _unsupportedIterableToArray(o,
minLen){if(o){if("string"===typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}}function _arrayLikeToArray(arr,len){if(null==len||len>arr.length)len=arr.length;for(var i=0,arr2=Array(len);i<len;i++)arr2[i]=arr[i];return arr2}global=require("module$node_modules$$babel$runtime$helpers$interopRequireDefault");
Object.defineProperty(exports,"__esModule",{value:!0});exports["default"]=void 0;var _defineProperty2=global(require("module$node_modules$$babel$runtime$helpers$defineProperty")),_classCallCheck2=global(require("module$node_modules$$babel$runtime$helpers$classCallCheck")),_createClass2=global(require("module$node_modules$$babel$runtime$helpers$createClass")),_core=require("module$node_modules$$luma_DOT_gl$core$dist$es5$index"),_assert=global(require("module$node_modules$$deck_DOT_gl$core$dist$es5$utils$assert")),
_log=global(require("module$node_modules$$deck_DOT_gl$core$dist$es5$utils$log")),_pickLayersPass=global(require("module$node_modules$$deck_DOT_gl$core$dist$es5$passes$pick_layers_pass")),_queryObject=require("module$node_modules$$deck_DOT_gl$core$dist$es5$lib$picking$query_object"),_pickInfo=require("module$node_modules$$deck_DOT_gl$core$dist$es5$lib$picking$pick_info");require=function(){function DeckPicker(gl){(0,_classCallCheck2["default"])(this,DeckPicker);this.gl=gl;this.pickingFBO=null;this.pickLayersPass=
new _pickLayersPass["default"](gl);this.layerFilter=null;this.lastPickedInfo={index:-1,layerId:null,info:null};this._onError=null}(0,_createClass2["default"])(DeckPicker,[{key:"setProps",value:function(props){"layerFilter"in props&&(this.layerFilter=props.layerFilter);"onError"in props&&(this._onError=props.onError);"_pickable"in props&&(this._pickable=props._pickable)}},{key:"finalize",value:function(){if(this.pickingFBO)this.pickingFBO["delete"]();this.depthFBO&&(this.depthFBO.color["delete"](),
this.depthFBO["delete"]())}},{key:"pickObject",value:function(opts){return this._pickClosestObject(opts)}},{key:"pickObjects",value:function(opts){return this._pickVisibleObjects(opts)}},{key:"getLastPickedObject",value:function(_ref){var x=_ref.x,y=_ref.y,layers=_ref.layers,viewports=_ref.viewports,lastPickedInfo=1<arguments.length&&void 0!==arguments[1]?arguments[1]:this.lastPickedInfo.info,lastPickedLayerId=lastPickedInfo&&lastPickedInfo.layer&&lastPickedInfo.layer.id,lastPickedViewportId=lastPickedInfo&&
lastPickedInfo.viewport&&lastPickedInfo.viewport.id;layers=lastPickedLayerId?layers.find(function(l){return l.id===lastPickedLayerId}):null;var coordinate=(viewports=lastPickedViewportId&&viewports.find(function(v){return v.id===lastPickedViewportId})||viewports[0])&&viewports.unproject([x-viewports.x,y-viewports.y]);x={x,y,viewport:viewports,coordinate,layer:layers};return layers?Object.assign({},lastPickedInfo,x):Object.assign(x,{color:null,object:null,index:-1})}},{key:"_resizeBuffer",value:function(){var gl=
this.gl;this.pickingFBO||(this.pickingFBO=new _core.Framebuffer(gl),_core.Framebuffer.isSupported(gl,{colorBufferFloat:!0})&&(this.depthFBO=new _core.Framebuffer(gl),this.depthFBO.attach((0,_defineProperty2["default"])({},36064,new _core.Texture2D(gl,{format:(0,_core.isWebGL2)(gl)?34836:6408,type:5126})))));this.pickingFBO.resize({width:gl.canvas.width,height:gl.canvas.height});this.depthFBO&&this.depthFBO.resize({width:gl.canvas.width,height:gl.canvas.height});return this.pickingFBO}},{key:"_getPickable",
value:function(layers){if(!1===this._pickable)return null;layers=layers.filter(function(layer){return layer.isPickable()&&!layer.isComposite});return 255<layers.length?(_log["default"].warn("Too many pickable layers, only picking the first 255")(),layers.slice(0,255)):layers.length?layers:null}},{key:"_pickClosestObject",value:function(_ref2){var layers=_ref2.layers,views=_ref2.views,viewports=_ref2.viewports,x=_ref2.x,y=_ref2.y,_ref2$radius=_ref2.radius,radius=void 0===_ref2$radius?0:_ref2$radius;
_ref2$radius=_ref2.depth;_ref2$radius=void 0===_ref2$radius?1:_ref2$radius;var _ref2$mode=_ref2.mode;_ref2$mode=void 0===_ref2$mode?"query":_ref2$mode;var unproject3D=_ref2.unproject3D;_ref2=_ref2.onViewportActive;layers=this._getPickable(layers);if(!layers)return{result:[],emptyInfo:(0,_pickInfo.getEmptyPickingInfo)({viewports,x,y})};this._resizeBuffer();var pixelRatio=(0,_core.cssToDeviceRatio)(this.gl),devicePixelRange=(0,_core.cssToDevicePixels)(this.gl,[x,y],!0);devicePixelRange=[devicePixelRange.x+
Math.floor(devicePixelRange.width/2),devicePixelRange.y+Math.floor(devicePixelRange.height/2)];radius=Math.round(radius*pixelRatio);var _this$pickingFBO=this.pickingFBO;_this$pickingFBO=this._getPickingRect({deviceX:devicePixelRange[0],deviceY:devicePixelRange[1],deviceRadius:radius,deviceWidth:_this$pickingFBO.width,deviceHeight:_this$pickingFBO.height});for(var infos,result=[],affectedLayers={},i=0;i<_ref2$radius;i++){infos=_this$pickingFBO&&this._drawAndSample({layers,views,viewports,onViewportActive:_ref2,
deviceRect:_this$pickingFBO,pass:"picking:".concat(_ref2$mode),redrawReason:_ref2$mode});var pickInfo=(0,_queryObject.getClosestObject)({pickedColors:infos,layers,deviceX:devicePixelRange[0],deviceY:devicePixelRange[1],deviceRadius:radius,deviceRect:_this$pickingFBO});infos=void 0;pickInfo.pickedLayer&&unproject3D&&this.depthFBO&&(infos=this._drawAndSample({layers:[pickInfo.pickedLayer],views,viewports,onViewportActive:_ref2,deviceRect:{x:pickInfo.pickedX,y:pickInfo.pickedY,width:1,height:1},pass:"picking:".concat(_ref2$mode),
redrawReason:"pick-z",pickZ:!0})[0]*viewports[0].distanceScales.metersPerUnit[2]+viewports[0].position[2]);if(pickInfo.pickedColor&&i+1<_ref2$radius){var layerId=pickInfo.pickedColor[3]-1;affectedLayers[layerId]=!0;layers[layerId].disablePickingIndex(pickInfo.pickedObjectIndex)}infos=(0,_pickInfo.processPickInfo)({pickInfo,lastPickedInfo:this.lastPickedInfo,mode:_ref2$mode,layers,layerFilter:this.layerFilter,viewports,x,y,z:infos,pixelRatio});layerId=_createForOfIteratorHelper(infos.values());var _step;
try{for(layerId.s();!(_step=layerId.n()).done;){var info=_step.value;info.layer&&result.push(info)}}catch(err){layerId.e(err)}finally{layerId.f()}if(!pickInfo.pickedColor)break}for(var _layerId in affectedLayers)layers[_layerId].restorePickingColors();return{result,emptyInfo:infos&&infos.get(null)}}},{key:"_pickVisibleObjects",value:function(_ref3){var layers=_ref3.layers,views=_ref3.views,viewports=_ref3.viewports,x=_ref3.x,y=_ref3.y,_ref3$width=_ref3.width;_ref3$width=void 0===_ref3$width?1:_ref3$width;
var _ref3$height=_ref3.height;_ref3$height=void 0===_ref3$height?1:_ref3$height;var _ref3$mode=_ref3.mode;_ref3$mode=void 0===_ref3$mode?"query":_ref3$mode;var _ref3$maxObjects=_ref3.maxObjects;_ref3$maxObjects=void 0===_ref3$maxObjects?null:_ref3$maxObjects;var onViewportActive=_ref3.onViewportActive;layers=this._getPickable(layers);if(!layers)return[];this._resizeBuffer();_ref3=(0,_core.cssToDeviceRatio)(this.gl);var leftTop=(0,_core.cssToDevicePixels)(this.gl,[x,y],!0),deviceLeft=leftTop.x;leftTop=
leftTop.y+leftTop.height;var rightBottom=(0,_core.cssToDevicePixels)(this.gl,[x+_ref3$width,y+_ref3$height],!0),deviceBottom=rightBottom.y;views=this._drawAndSample({layers,views,viewports,onViewportActive,deviceRect:{x:deviceLeft,y:deviceBottom,width:rightBottom.x+rightBottom.width-deviceLeft,height:leftTop-deviceBottom},pass:"picking:".concat(_ref3$mode),redrawReason:_ref3$mode});layers=(0,_queryObject.getUniqueObjects)({pickedColors:views,layers});views=new Map;viewports=Number.isFinite(_ref3$maxObjects);
for(onViewportActive=0;onViewportActive<layers.length&&!(viewports&&views.size>=_ref3$maxObjects);onViewportActive++)deviceLeft=layers[onViewportActive],leftTop={color:deviceLeft.pickedColor,layer:null,index:deviceLeft.pickedObjectIndex,picked:!0,x,y,width:_ref3$width,height:_ref3$height,pixelRatio:_ref3},leftTop=(0,_pickInfo.getLayerPickingInfo)({layer:deviceLeft.pickedLayer,info:leftTop,mode:_ref3$mode}),views.has(leftTop.object)||views.set(leftTop.object,leftTop);return Array.from(views.values())}},
{key:"_drawAndSample",value:function(_ref4){var layers=_ref4.layers,views=_ref4.views,viewports=_ref4.viewports,onViewportActive=_ref4.onViewportActive,deviceRect=_ref4.deviceRect,pass=_ref4.pass,redrawReason=_ref4.redrawReason,pickZ=_ref4.pickZ;(0,_assert["default"])(0<deviceRect.width&&0<deviceRect.height);if(1>layers.length)return null;_ref4=pickZ?this.depthFBO:this.pickingFBO;this.pickLayersPass.render({layers,layerFilter:this.layerFilter,onError:this._onError,views,viewports,onViewportActive,
pickingFBO:_ref4,deviceRect,pass,redrawReason,pickZ});layers=deviceRect.x;views=deviceRect.y;viewports=deviceRect.width;deviceRect=deviceRect.height;pickZ=new (pickZ?Float32Array:Uint8Array)(viewports*deviceRect*4);(0,_core.readPixelsToArray)(_ref4,{sourceX:layers,sourceY:views,sourceWidth:viewports,sourceHeight:deviceRect,target:pickZ});return pickZ}},{key:"_getPickingRect",value:function(_ref5){var deviceX=_ref5.deviceX,deviceY=_ref5.deviceY,deviceRadius=_ref5.deviceRadius,x=Math.max(0,deviceX-
deviceRadius),y=Math.max(0,deviceY-deviceRadius);deviceX=Math.min(_ref5.deviceWidth,deviceX+deviceRadius+1)-x;_ref5=Math.min(_ref5.deviceHeight,deviceY+deviceRadius+1)-y;return 0>=deviceX||0>=_ref5?null:{x,y,width:deviceX,height:_ref5}}}]);return DeckPicker}();exports["default"]=require}
//# sourceMappingURL=module$node_modules$$deck_DOT_gl$core$dist$es5$lib$deck_picker.js.map
