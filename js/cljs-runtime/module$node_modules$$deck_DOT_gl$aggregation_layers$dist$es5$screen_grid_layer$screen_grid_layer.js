shadow$provide.module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$screen_grid_layer$screen_grid_layer=function(global,require,module,exports){function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function(){var Super=(0,_getPrototypeOf2["default"])(Derived);if(hasNativeReflectConstruct){var NewTarget=(0,_getPrototypeOf2["default"])(this).constructor;Super=Reflect.construct(Super,arguments,NewTarget)}else Super=Super.apply(this,arguments);return(0,
_possibleConstructorReturn2["default"])(this,Super)}}function _isNativeReflectConstruct(){if("undefined"===typeof Reflect||!Reflect.construct||Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}global=require("module$node_modules$$babel$runtime$helpers$interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:!0});exports["default"]=void 0;var _defineProperty2=
global(require("module$node_modules$$babel$runtime$helpers$defineProperty")),_classCallCheck2=global(require("module$node_modules$$babel$runtime$helpers$classCallCheck")),_createClass2=global(require("module$node_modules$$babel$runtime$helpers$createClass")),_get2=global(require("module$node_modules$$babel$runtime$helpers$get")),_inherits2=global(require("module$node_modules$$babel$runtime$helpers$inherits")),_possibleConstructorReturn2=global(require("module$node_modules$$babel$runtime$helpers$possibleConstructorReturn")),
_getPrototypeOf2=global(require("module$node_modules$$babel$runtime$helpers$getPrototypeOf")),_core=require("module$node_modules$$deck_DOT_gl$core$dist$es5$index"),_gpuGridAggregator=global(require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$utils$gpu_grid_aggregation$gpu_grid_aggregator")),_aggregationOperationUtils=require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$utils$aggregation_operation_utils"),_screenGridCellLayer=global(require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$screen_grid_layer$screen_grid_cell_layer"));
global=global(require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$grid_aggregation_layer"));var _resourceUtils=require("module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$utils$resource_utils");require=Object.assign({},_screenGridCellLayer["default"].defaultProps,{getPosition:{type:"accessor",value:function(d){return d.position}},getWeight:{type:"accessor",value:1},gpuAggregation:!0,aggregation:"SUM"});var DIMENSIONS={data:{props:["cellSizePixels"]},weights:{props:["aggregation"],
accessors:["getWeight"]}};global=function(_GridAggregationLayer){function ScreenGridLayer(){(0,_classCallCheck2["default"])(this,ScreenGridLayer);return _super.apply(this,arguments)}(0,_inherits2["default"])(ScreenGridLayer,_GridAggregationLayer);var _super=_createSuper(ScreenGridLayer);(0,_createClass2["default"])(ScreenGridLayer,[{key:"initializeState",value:function(){var _attributeManager$add,gl=this.context.gl;_screenGridCellLayer["default"].isSupported(gl)?((0,_get2["default"])((0,_getPrototypeOf2["default"])(ScreenGridLayer.prototype),
"initializeState",this).call(this,{dimensions:DIMENSIONS,getCellSize:function(props){return props.cellSizePixels}}),gl={count:{size:1,operation:_aggregationOperationUtils.AGGREGATION_OPERATION.SUM,needMax:!0,maxTexture:(0,_resourceUtils.getFloatTexture)(gl,{id:"".concat(this.id,"-max-texture")})}},this.setState({supported:!0,projectPoints:!0,weights:gl,subLayerData:{attributes:{}},maxTexture:gl.count.maxTexture,positionAttributeName:"positions",posOffset:[0,0],translation:[1,-1]}),this.getAttributeManager().add((_attributeManager$add=
{},(0,_defineProperty2["default"])(_attributeManager$add,"positions",{size:3,accessor:"getPosition",type:5130,fp64:this.use64bitPositions()}),(0,_defineProperty2["default"])(_attributeManager$add,"count",{size:3,accessor:"getWeight"}),_attributeManager$add))):(this.setState({supported:!1}),_core.log.error("ScreenGridLayer: ".concat(this.id," is not supported on this browser"))())}},{key:"shouldUpdateState",value:function(_ref){_ref=_ref.changeFlags;return this.state.supported&&_ref.somethingChanged}},
{key:"updateState",value:function(opts){(0,_get2["default"])((0,_getPrototypeOf2["default"])(ScreenGridLayer.prototype),"updateState",this).call(this,opts)}},{key:"renderLayers",value:function(){if(!this.state.supported)return[];var _this$state=this.state,maxTexture=_this$state.maxTexture,numRow=_this$state.numRow,numCol=_this$state.numCol,updateTriggers=this.props.updateTriggers;_this$state=_this$state.weights.count.aggregationBuffer;return new (this.getSubLayerClass("cells",_screenGridCellLayer["default"]))(this.props,
this.getSubLayerProps({id:"cell-layer",updateTriggers}),{data:{attributes:{instanceCounts:_this$state}},maxTexture,numInstances:numRow*numCol})}},{key:"finalizeState",value:function(){(0,_get2["default"])((0,_getPrototypeOf2["default"])(ScreenGridLayer.prototype),"finalizeState",this).call(this);var _this$state2=this.state,aggregationBuffer=_this$state2.aggregationBuffer,maxBuffer=_this$state2.maxBuffer;_this$state2=_this$state2.maxTexture;if(aggregationBuffer)aggregationBuffer["delete"]();if(maxBuffer)maxBuffer["delete"]();
if(_this$state2)_this$state2["delete"]()}},{key:"getPickingInfo",value:function(_ref2){_ref2=_ref2.info;var index=_ref2.index;if(0<=index){var aggregationResults=this.state.gpuGridAggregator.getData("count");_ref2.object=_gpuGridAggregator["default"].getAggregationData(Object.assign({pixelIndex:index},aggregationResults))}return _ref2}},{key:"updateResults",value:function(_ref3){var aggregationData=_ref3.aggregationData;_ref3=_ref3.maxData;var count=this.state.weights.count;count.aggregationData=
aggregationData;count.aggregationBuffer.setData({data:aggregationData});count.maxData=_ref3;count.maxTexture.setImageData({data:_ref3})}},{key:"updateAggregationState",value:function(opts){var cellSize=opts.props.cellSizePixels,cellSizeChanged=opts.oldProps.cellSizePixels!==cellSize,viewportChanged=opts.changeFlags.viewportChanged,gpuAggregation=opts.props.gpuAggregation;this.state.gpuAggregation!==opts.props.gpuAggregation&&gpuAggregation&&!_gpuGridAggregator["default"].isSupported(this.context.gl)&&
(_core.log.warn("GPU Grid Aggregation not supported, falling back to CPU")(),gpuAggregation=!1);var gpuAggregationChanged=gpuAggregation!==this.state.gpuAggregation;this.setState({gpuAggregation});var positionsChanged=this.isAttributeChanged("positions"),dimensions=this.state.dimensions,data=dimensions.data;dimensions=dimensions.weights;gpuAggregation=positionsChanged||gpuAggregationChanged||viewportChanged||this.isAggregationDirty(opts,{compareAll:gpuAggregation,dimension:data});gpuAggregationChanged=
this.isAggregationDirty(opts,{dimension:dimensions});this.setState({aggregationDataDirty:gpuAggregation,aggregationWeightsDirty:gpuAggregationChanged});positionsChanged=this.context.viewport;if(viewportChanged||cellSizeChanged)cellSizeChanged=positionsChanged.width,viewportChanged=positionsChanged.height,positionsChanged=Math.ceil(cellSizeChanged/cellSize),data=Math.ceil(viewportChanged/cellSize),this.allocateResources(data,positionsChanged),this.setState({scaling:[cellSizeChanged/2,-viewportChanged/
2,1],gridOffset:{xOffset:cellSize,yOffset:cellSize},width:cellSizeChanged,height:viewportChanged,numCol:positionsChanged,numRow:data});gpuAggregationChanged&&this._updateAccessors(opts);(gpuAggregation||gpuAggregationChanged)&&this._resetResults()}},{key:"_updateAccessors",value:function(opts){var _opts$props=opts.props;opts=_opts$props.getWeight;var aggregation=_opts$props.aggregation;_opts$props=_opts$props.data;var count=this.state.weights.count;count&&(count.getWeight=opts,count.operation=_aggregationOperationUtils.AGGREGATION_OPERATION[aggregation]);
this.setState({getValue:(0,_aggregationOperationUtils.getValueFunc)(aggregation,opts,{data:_opts$props})})}},{key:"_resetResults",value:function(){var count=this.state.weights.count;count&&(count.aggregationData=null)}}]);return ScreenGridLayer}(global["default"]);exports["default"]=global;global.layerName="ScreenGridLayer";global.defaultProps=require}
//# sourceMappingURL=module$node_modules$$deck_DOT_gl$aggregation_layers$dist$es5$screen_grid_layer$screen_grid_layer.js.map
