shadow$provide.module$node_modules$$loaders_DOT_gl$tiles$dist$es5$tileset$tile_3d=function(global,require,module,exports){function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);enumerableOnly&&(symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable}));keys.push.apply(keys,symbols)}return keys}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=
null!=arguments[i]?arguments[i]:{};i%2?ownKeys(Object(source),!0).forEach(function(key){(0,_defineProperty2["default"])(target,key,source[key])}):Object.getOwnPropertyDescriptors?Object.defineProperties(target,Object.getOwnPropertyDescriptors(source)):ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key))})}return target}global=require("module$node_modules$$babel$runtime$helpers$interopRequireDefault");Object.defineProperty(exports,
"__esModule",{value:!0});exports["default"]=void 0;var _regenerator=global(require("module$node_modules$$babel$runtime$regenerator$index")),_defineProperty2=global(require("module$node_modules$$babel$runtime$helpers$defineProperty")),_asyncToGenerator2=global(require("module$node_modules$$babel$runtime$helpers$asyncToGenerator")),_typeof2=global(require("module$node_modules$$babel$runtime$helpers$typeof")),_classCallCheck2=global(require("module$node_modules$$babel$runtime$helpers$classCallCheck")),
_createClass2=global(require("module$node_modules$$babel$runtime$helpers$createClass")),_core=require("module$node_modules$$math_DOT_gl$core$dist$es5$index"),_culling=require("module$node_modules$$math_DOT_gl$culling$dist$es5$index"),_core2=require("module$node_modules$$loaders_DOT_gl$core$dist$es5$index"),_loaderUtils=require("module$node_modules$$loaders_DOT_gl$loader_utils$dist$es5$index"),_constants=require("module$node_modules$$loaders_DOT_gl$tiles$dist$es5$constants"),_boundingVolume=require("module$node_modules$$loaders_DOT_gl$tiles$dist$es5$tileset$helpers$bounding_volume"),
_tiles3dLod=require("module$node_modules$$loaders_DOT_gl$tiles$dist$es5$tileset$helpers$tiles_3d_lod"),_i3sLod=require("module$node_modules$$loaders_DOT_gl$tiles$dist$es5$tileset$helpers$i3s_lod"),scratchVector=new _core.Vector3;require=function(){function TileHeader(tileset,header,parentHeader){(0,_classCallCheck2["default"])(this,TileHeader);(0,_loaderUtils.assert)("object"===(0,_typeof2["default"])(header));this.header=header;this.tileset=tileset;this.id=header.id;this.url=header.url;this.parent=
parentHeader;this.refine=this._getRefine(header.refine);this.type=header.type;this.contentUrl=header.contentUrl;this.content=this.boundingVolume=this.lodMetricValue=this.lodMetricType=null;this.contentState=_constants.TILE_CONTENT_STATE.UNLOADED;this.gpuMemoryUsageInBytes=0;this.children=[];this.depth=0;this._cacheNode=this._frameNumber=null;this._initializeLodMetric(header);this._initializeTransforms(header);this._initializeBoundingVolumes(header);this._initializeContent(header);this._initializeRenderingState(header);
this._expiredContent=this._expireDate=this._lodJudge=null;this._getPriority=this._getPriority.bind(this);Object.seal(this)}(0,_createClass2["default"])(TileHeader,[{key:"destroy",value:function(){this.header=null}},{key:"isDestroyed",value:function(){return null===this.header}},{key:"getScreenSpaceError",value:function(frameState,useParentLodMetric){switch(this.tileset.type){case _constants.TILESET_TYPE.I3S:return(0,_i3sLod.getI3ScreenSize)(this,frameState);case _constants.TILESET_TYPE.TILES3D:return(0,
_tiles3dLod.getTiles3DScreenSpaceError)(this,frameState,useParentLodMetric);default:return console.error("Unsupported tileset type"),null}}},{key:"_getPriority",value:function(){return this.isVisible&&this.contentState!==_constants.TILE_CONTENT_STATE.UNLOADED?Math.max(1E7-this._priority,0)||0:-1}},{key:"loadContent",value:function(){var _loadContent=(0,_asyncToGenerator2["default"])(_regenerator["default"].mark(function _callee(){var expired,requestToken,contentUrl,fetchOptions,loader,options;return _regenerator["default"].wrap(function(_context){for(;;)switch(_context.prev=
_context.next){case 0:if(!this.hasEmptyContent){_context.next=2;break}return _context.abrupt("return",!1);case 2:if(!this.content){_context.next=4;break}return _context.abrupt("return",!0);case 4:if(expired=this.contentExpired)this._expireDate=null;this.contentState=_constants.TILE_CONTENT_STATE.LOADING;_context.next=9;return this.tileset._requestScheduler.scheduleRequest(this.id,this._getPriority);case 9:if(requestToken=_context.sent){_context.next=13;break}this.contentState=_constants.TILE_CONTENT_STATE.UNLOADED;
return _context.abrupt("return",!1);case 13:return _context.prev=13,contentUrl=this.tileset.getTileUrl(this.contentUrl),fetchOptions=this.tileset.fetchOptions,loader=this.tileset.loader,options=_objectSpread(_objectSpread({},fetchOptions),{},(0,_defineProperty2["default"])({},loader.id,{tile:this.header,tileset:this.tileset.tileset,isTileset:"auto",isTileHeader:!1,assetGltfUpAxis:this.tileset.asset.gltfUpAxis})),_context.next=20,(0,_core2.load)(contentUrl,loader,options);case 20:return this.content=
_context.sent,this._isTileset()&&this.tileset._initializeTileHeaders(this.content,this,_loaderUtils.path.dirname(this.contentUrl)),this.contentState=_constants.TILE_CONTENT_STATE.READY,this._onContentLoaded(),_context.abrupt("return",!0);case 27:throw _context.prev=27,_context.t0=_context["catch"](13),this.contentState=_constants.TILE_CONTENT_STATE.FAILED,_context.t0;case 31:return _context.prev=31,requestToken.done(),_context.finish(31);case 34:case "end":return _context.stop()}},_callee,this,[[13,
27,31,34]])}));return function(){return _loadContent.apply(this,arguments)}}()},{key:"unloadContent",value:function(){this.content&&this.content.destroy&&this.content.destroy();this.content=null;this.contentState=_constants.TILE_CONTENT_STATE.UNLOADED;return!0}},{key:"updateVisibility",value:function(frameState){if(this._frameNumber!==frameState.frameNumber){var parent=this.parent,parentVisibilityPlaneMask=parent?parent._visibilityPlaneMask:_culling.CullingVolume.MASK_INDETERMINATE;this._updateTransform(parent?
parent.computedTransform:this.tileset.modelMatrix);this._distanceToCamera=this.distanceToTile(frameState);this._screenSpaceError=this.getScreenSpaceError(frameState,!1);this._visibilityPlaneMask=this.visibility(frameState,parentVisibilityPlaneMask);this._visible=this._visibilityPlaneMask!==_culling.CullingVolume.MASK_OUTSIDE;this._inRequestVolume=this.insideViewerRequestVolume(frameState);this._priority=this.lodMetricValue;this._frameNumber=frameState.frameNumber}}},{key:"visibility",value:function(frameState,
parentVisibilityPlaneMask){return frameState.cullingVolume.computeVisibilityWithPlaneMask(this.boundingVolume,parentVisibilityPlaneMask)}},{key:"contentVisibility",value:function(frameState){return!0}},{key:"distanceToTile",value:function(frameState){return Math.sqrt(Math.max(this.boundingVolume.distanceSquaredTo(frameState.camera.position),0))}},{key:"cameraSpaceZDepth",value:function(_ref){_ref=_ref.camera;scratchVector.subVectors(this.boundingVolume.center,_ref.position);return _ref.direction.dot(scratchVector)}},
{key:"insideViewerRequestVolume",value:function(frameState){var viewerRequestVolume=this._viewerRequestVolume;return!viewerRequestVolume||0===viewerRequestVolume.distanceToCamera(frameState.camera.position)}},{key:"_initializeLodMetric",value:function(header){"lodMetricType"in header?this.lodMetricType=header.lodMetricType:(this.lodMetricType=this.parent&&this.parent.lodMetricType||this.tileset.lodMetricType,console.warn("3D Tile: Required prop lodMetricType is undefined. Using parent lodMetricType"));
"lodMetricValue"in header?this.lodMetricValue=header.lodMetricValue:(this.lodMetricValue=this.parent&&this.parent.lodMetricValue||this.tileset.lodMetricValue,console.warn("3D Tile: Required prop lodMetricValue is undefined. Using parent lodMetricValue"))}},{key:"_initializeTransforms",value:function(tileHeader){this.transform=tileHeader.transform?new _core.Matrix4(tileHeader.transform):new _core.Matrix4;tileHeader=this.parent;var tileset=this.tileset;tileset=tileHeader&&tileHeader.computedTransform?
tileHeader.computedTransform.clone():tileset.modelMatrix.clone();this.computedTransform=(new _core.Matrix4(tileset)).multiplyRight(this.transform);tileHeader=tileHeader&&tileHeader._initialTransform?tileHeader._initialTransform.clone():new _core.Matrix4;this._initialTransform=(new _core.Matrix4(tileHeader)).multiplyRight(this.transform)}},{key:"_initializeBoundingVolumes",value:function(tileHeader){this._viewerRequestVolume=this._contentBoundingVolume=null;this._updateBoundingVolume(tileHeader)}},
{key:"_initializeContent",value:function(tileHeader){this.content={_tileset:this.tileset,_tile:this};this.hasEmptyContent=!0;this.contentState=_constants.TILE_CONTENT_STATE.UNLOADED;this.hasTilesetContent=!1;tileHeader.contentUrl&&(this.content=null,this.hasEmptyContent=!1)}},{key:"_initializeRenderingState",value:function(header){this.depth=header.level;this._shouldRefine=!1;this._screenSpaceError=this._centerZDepth=this._distanceToCamera=0;this._visibilityPlaneMask=_culling.CullingVolume.MASK_INDETERMINATE;
this._inRequestVolume=this._visible=!1;this._priority=this._requestedFrame=this._selectedFrame=this._visitedFrame=this._touchedFrame=this._frameNumber=this._selectionDepth=this._stackLength=0}},{key:"_getRefine",value:function(refine){return refine||this.parent&&this.parent.refine||_constants.TILE_REFINEMENT.REPLACE}},{key:"_isTileset",value:function(){return-1!==this.contentUrl.indexOf(".json")}},{key:"_onContentLoaded",value:function(){switch(this.content&&this.content.type){case "vctr":case "geom":this.tileset.traverser.disableSkipLevelOfDetail=
!0}this._isTileset()&&(this.hasTilesetContent=!0)}},{key:"_updateBoundingVolume",value:function(header){this.boundingVolume=(0,_boundingVolume.createBoundingVolume)(header.boundingVolume,this.computedTransform,this.boundingVolume);var content=header.content;content&&(content.boundingVolume&&(this._contentBoundingVolume=(0,_boundingVolume.createBoundingVolume)(content.boundingVolume,this.computedTransform,this._contentBoundingVolume)),header.viewerRequestVolume&&(this._viewerRequestVolume=(0,_boundingVolume.createBoundingVolume)(header.viewerRequestVolume,
this.computedTransform,this._viewerRequestVolume)))}},{key:"_updateTransform",value:function(){var computedTransform=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:new _core.Matrix4).clone().multiplyRight(this.transform);computedTransform.equals(this.computedTransform)||(this.computedTransform=computedTransform,this._updateBoundingVolume(this.header))}},{key:"updateExpiration",value:function(){var x=this._expireDate;void 0!==x&&null!==x&&this.contentReady&&!this.hasEmptyContent&&(x=Date.now(),
Date.lessThan(this._expireDate,x)&&(this.contentState=_constants.TILE_CONTENT_STATE.EXPIRED,this._expiredContent=this.content))}},{key:"selected",get:function(){return this._selectedFrame===this.tileset._frameNumber}},{key:"isVisible",get:function(){return this._visible}},{key:"isVisibleAndInRequestVolume",get:function(){return this._visible&&this._inRequestVolume}},{key:"hasRenderContent",get:function(){return!this.hasEmptyContent&&!this.hasTilesetContent}},{key:"hasChildren",get:function(){return 0<
this.children.length||this.header.children&&0<this.header.children.length}},{key:"contentReady",get:function(){return this.contentState===_constants.TILE_CONTENT_STATE.READY||this.hasEmptyContent}},{key:"contentAvailable",get:function(){return!!(this.contentReady&&this.hasRenderContent||this._expiredContent&&!this.contentFailed)}},{key:"hasUnloadedContent",get:function(){return this.hasRenderContent&&this.contentUnloaded}},{key:"contentUnloaded",get:function(){return this.contentState===_constants.TILE_CONTENT_STATE.UNLOADED}},
{key:"contentExpired",get:function(){return this.contentState===_constants.TILE_CONTENT_STATE.EXPIRED}},{key:"contentFailed",get:function(){return this.contentState===_constants.TILE_CONTENT_STATE.FAILED}},{key:"extras",get:function(){return this.header.extras}}]);return TileHeader}();exports["default"]=require}
//# sourceMappingURL=module$node_modules$$loaders_DOT_gl$tiles$dist$es5$tileset$tile_3d.js.map
